<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>櫻花之路 2.0 - 日本五十音學習遊戲</title>
    <!-- Favicon -->
    <link rel="icon" href="./images/icon.png" type="image/png" />

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700;900&display=swap"
      rel="stylesheet"
    />
    <!-- Chart.js for progress charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      /* --- 全局與櫻花主題樣式 --- */
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
        background: linear-gradient(135deg, #fff0f5 0%, #ffe4e1 100%);
      }

      /* Glass Morphism 效果 */
      .glass-morphism {
        background-color: rgba(255, 255, 255, 0.55);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px 0 rgba(200, 100, 135, 0.2);
        border-radius: 1.5rem;
      }

      /* 櫻花卡片樣式 */
      .sakura-card {
        background-color: rgba(255, 255, 255, 0.65);
        border-radius: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.4);
      }
      .sakura-card:hover {
        transform: translateY(-10px) scale(1.03);
        box-shadow: 0 12px 24px rgba(255, 105, 180, 0.2);
      }

      /* 主按鈕 */
      .btn-primary {
        background: linear-gradient(135deg, #ff9a9e, #fecfef);
        color: white;
        border-radius: 0.75rem;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 15px rgba(255, 154, 158, 0.4);
        transition: all 0.3s ease;
        border: none;
      }
      .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(255, 154, 158, 0.6);
      }
      .btn-primary:disabled {
        background: #d1d5db;
        box-shadow: none;
        cursor: not-allowed;
      }

      /* 次要按鈕 */
      .btn-secondary {
        background-color: #fff;
        color: #ff69b4;
        border: 2px solid #ff9a9e;
        border-radius: 0.75rem;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }
      .btn-secondary:hover {
        background-color: #ff9a9e;
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(255, 154, 158, 0.4);
      }

      /* 導覽連結 */
      .nav-link {
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        transition: all 0.3s ease-in-out;
        font-weight: 600;
        color: #4a5568;
        background-color: rgba(255, 255, 255, 0.4);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      .nav-link.active {
        background: linear-gradient(45deg, #ff6b6b, #ff9a9e);
        color: white;
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        transform: scale(1.05);
      }
      .nav-link:hover:not(.active) {
        background-color: rgba(255, 255, 255, 0.8);
        color: #ff69b4;
      }

      /* 標題 */
      .section-title {
        background: linear-gradient(to right, #ff69b4, #c71585);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 900;
        font-family: "Noto Sans JP", sans-serif;
      }

      /* 輸入框 */
      .input-field {
        background-color: rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(255, 182, 193, 0.8);
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
        color: #4a5568;
        outline: none;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }
      .input-field:focus {
        border-color: #ff69b4;
        box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.3);
      }

      /* 彈出式視窗 (Modal) */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }
      .modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }
      .modal-content {
        transform: scale(0.95);
        transition: transform 0.3s ease;
      }
      .modal-overlay.active .modal-content {
        transform: scale(1);
      }

      /* 遊戲專用樣式 */
      .game-option-button {
        background: white;
        border: 2px solid #ffc0cb;
        color: #db2777;
        transition: all 0.2s ease-in-out;
      }
      .game-option-button:hover {
        transform: scale(1.05);
        background: #fbcfe8;
        border-color: #f472b6;
      }
      .game-option-button.correct {
        background: #a7f3d0;
        border-color: #10b981;
      }
      .game-option-button.incorrect {
        background: #fecaca;
        border-color: #ef4444;
      }

      /* 和風填字遊戲樣式 */
      #crossword-grid {
        display: grid;
        gap: 2px;
        position: relative;
      }
      .crossword-cell-container {
        position: relative;
        width: 40px;
        height: 40px;
      }
      .crossword-number {
        position: absolute;
        top: 1px;
        left: 2px;
        font-size: 0.6rem;
        font-weight: bold;
        color: #a855f7;
      }
      .crossword-cell {
        width: 100%;
        height: 100%;
        text-align: center;
        font-size: 1.5rem;
        border: 1px solid #ffc0cb;
        background-color: white;
        border-radius: 4px;
        caret-color: #ff69b4;
        text-transform: uppercase;
        font-family: "Noto Sans JP", sans-serif;
      }
      .crossword-cell:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.5);
        z-index: 10;
      }
      .crossword-cell.highlight {
        background-color: #fbcfe8;
      }
      .crossword-cell.correct {
        background-color: #dcfce7;
        color: #166534;
        font-weight: bold;
        animation: bounce 0.5s;
      }
      .crossword-cell.incorrect {
        background-color: #fee2e2;
        color: #991b1b;
        animation: shake 0.5s;
      }
      .crossword-clue {
        transition: background-color 0.2s;
      }
      .crossword-clue.active {
        background-color: #ffe4e1;
        border-radius: 0.5rem;
      }
      @keyframes bounce {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      /* 學習日曆樣式 */
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }
      .calendar-day {
        aspect-ratio: 1 / 1;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        transition: all 0.2s;
      }
      .calendar-day.studied {
        background: linear-gradient(135deg, #ff9a9e, #fecfef);
        box-shadow: 0 2px 8px rgba(255, 154, 158, 0.5);
      }

      /* 提示訊息樣式 */
      #custom-alert-message {
        white-space: pre-wrap;
        text-align: left;
        background-color: rgba(255, 228, 225, 0.5);
        padding: 1rem;
        border-radius: 0.5rem;
        font-family: monospace;
        font-size: 0.875rem;
        max-height: 50vh;
        overflow-y: auto;
      }
    </style>
  </head>
  <body
    class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8"
  >
    <!-- Header Section -->
    <header
      class="w-full max-w-6xl mb-8 sm:mb-12 flex items-center justify-between px-4"
    >
      <!-- Left side: Logo and Title -->
      <div class="flex items-center gap-3 sm:gap-4 overflow-hidden">
        <img
          src="./images/pip.png"
          alt="Logo"
          class="h-8 sm:h-12 object-contain flex-shrink-0"
        />
        <div class="overflow-hidden">
          <h1
            class="text-xl sm:text-4xl font-extrabold tracking-tight section-title whitespace-nowrap"
          >
            櫻花之路
          </h1>
          <p class="hidden sm:block text-pink-500 text-sm font-semibold">
            (Sakura no Michi)
          </p>
        </div>
      </div>
      <!-- Right side: User Actions -->
      <div
        id="user-actions"
        class="flex items-center gap-2 sm:gap-4 flex-shrink-0"
      >
        <button
          id="login-button"
          class="btn-secondary text-sm sm:text-base whitespace-nowrap"
        >
          登入
        </button>
        <div id="user-menu" class="hidden items-center gap-3">
          <span
            id="user-name"
            class="font-semibold text-gray-700 hidden sm:block"
          ></span>
          <img
            id="user-avatar"
            class="h-8 w-8 sm:h-10 sm:w-10 rounded-md cursor-pointer object-cover"
            alt="User Avatar"
          />
          <button
            id="logout-button"
            class="p-2 rounded-full hover:bg-white/50 transition-colors"
            title="登出"
          >
            <svg
              class="w-6 h-6 text-red-500"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
              />
            </svg>
          </button>
        </div>
        <button
          id="settings-button"
          class="p-2 sm:p-3 rounded-full hover:bg-white/50 transition-colors"
          title="API 設定"
        >
          <svg
            class="h-6 w-6 text-pink-500"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            />
          </svg>
        </button>
      </div>
    </header>

    <!-- Main Navigation -->
    <nav
      class="w-full max-w-4xl glass-morphism p-4 mb-12 flex flex-wrap justify-center gap-4"
    >
      <button class="nav-link active" data-section="pronunciation-teaching">
        發音教學
      </button>
      <button class="nav-link" data-section="phrase-practice">詞句練習</button>
      <button class="nav-link" data-section="ai-conversation">AI 對話</button>
      <button class="nav-link" data-section="progress-calendar">
        學習歷程
      </button>
    </nav>

    <!-- Main Content -->
    <main id="main-content" class="w-full max-w-6xl glass-morphism p-6 md:p-8">
      <!-- Loading State -->
      <div id="loading-state" class="text-center py-16">
        <h2 class="text-2xl font-semibold text-pink-500 animate-pulse">
          資料載入中，請稍候...
        </h2>
      </div>

      <!-- Sections will be dynamically shown/hidden here -->
      <section id="pronunciation-teaching" class="hidden">
        <h2 class="text-4xl section-title mb-8 text-center">五十音發音教學</h2>
        <div
          id="hiragana-cards-container"
          class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6"
        ></div>
      </section>

      <section id="phrase-practice" class="hidden">
        <!-- This section now acts as a container for the menu and games -->
        <div id="practice-menu">
          <h2 class="text-4xl section-title mb-8 text-center">詞句練習</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="sakura-card p-6 text-center flex flex-col">
              <h3 class="text-2xl font-bold text-gray-800 mb-4">每日練習卡</h3>
              <p class="text-gray-700 mb-4 flex-grow">
                每日一卡，輕鬆鞏固您的日語基礎！
              </p>
              <button
                class="btn-primary mt-auto"
                data-practice="daily-practice"
              >
                開始練習
              </button>
            </div>
            <div class="sakura-card p-6 text-center flex flex-col">
              <h3 class="text-2xl font-bold text-gray-800 mb-4">
                櫻花單字配對
              </h3>
              <p class="text-gray-700 mb-4 flex-grow">
                計時挑戰！在飛舞的櫻花中選出正確讀音。
              </p>
              <button
                class="btn-secondary mt-auto"
                data-practice="word-match-game"
              >
                開始遊戲
              </button>
            </div>
            <div class="sakura-card p-6 text-center flex flex-col">
              <h3 class="text-2xl font-bold text-gray-800 mb-4">和風填字</h3>
              <p class="text-gray-700 mb-4 flex-grow">
                挑戰你的詞彙量，完成日式填字謎題。
              </p>
              <button
                class="btn-secondary mt-auto"
                data-practice="crossword-game"
              >
                開始遊戲
              </button>
            </div>
          </div>
        </div>

        <!-- Daily Practice Interface -->
        <div id="daily-practice-interface" class="hidden text-center">
          <h2 class="text-3xl section-title mb-6">每日練習卡</h2>
          <div
            id="daily-card-container"
            class="sakura-card max-w-md mx-auto p-8 min-h-[300px] flex flex-col justify-center items-center"
          ></div>
          <div class="mt-6 flex justify-center gap-4">
            <button class="btn-secondary back-to-menu">返回選單</button>
            <button id="next-daily-card" class="btn-primary">下一張</button>
          </div>
        </div>

        <!-- Sakura Word Match Game Interface -->
        <div id="word-match-game-interface" class="hidden">
          <h2 class="text-4xl section-title mb-4 text-center">櫻花單字配對</h2>
          <div
            class="flex justify-between items-center max-w-lg mx-auto mb-4 text-xl font-bold text-gray-700"
          >
            <div>
              時間: <span id="game-timer" class="text-pink-500">30</span>s
            </div>
            <div>
              得分: <span id="game-score" class="text-pink-500">0</span>
            </div>
          </div>
          <div class="sakura-card max-w-lg mx-auto p-8 text-center">
            <div id="game-question-area">
              <p class="text-2xl text-gray-600 mb-4">
                請選擇「<span
                  id="game-question-word"
                  class="font-bold text-fuchsia-700"
                ></span
                >」的正確讀音：
              </p>
              <div
                id="game-options-container"
                class="grid grid-cols-2 gap-4"
              ></div>
            </div>
            <div id="game-over-area" class="hidden">
              <h3 class="text-3xl font-bold text-pink-600 mb-4">時間到！</h3>
              <p class="text-xl text-gray-700">您的最終得分是：</p>
              <p
                id="final-score"
                class="text-6xl font-bold text-fuchsia-700 my-4"
              >
                0
              </p>
              <button id="restart-word-match-game" class="btn-primary">
                再玩一次
              </button>
            </div>
            <div id="game-feedback" class="mt-4 h-6 text-lg font-bold"></div>
          </div>
          <div class="mt-6 text-center">
            <button class="btn-secondary back-to-menu">返回選單</button>
          </div>
        </div>

        <!-- Crossword Game Interface -->
        <div id="crossword-game-interface" class="hidden">
          <h2 class="text-4xl section-title mb-8 text-center">和風填字</h2>
          <div class="flex flex-col lg:flex-row gap-8 items-start">
            <div class="flex-grow sakura-card p-6 flex justify-center">
              <div id="crossword-grid"></div>
            </div>
            <div class="lg:w-1/3 sakura-card p-6 w-full">
              <h3 class="text-2xl font-bold text-gray-800 mb-4">提示</h3>
              <div
                id="crossword-clues"
                class="space-y-2 max-h-60 overflow-y-auto"
              ></div>
              <button id="check-crossword-btn" class="btn-primary w-full mt-6">
                檢查答案
              </button>
              <button class="btn-secondary w-full mt-3 back-to-menu">
                返回選單
              </button>
            </div>
          </div>
        </div>
      </section>

      <section id="ai-conversation" class="hidden">
        <h2 class="text-4xl section-title mb-8 text-center">AI 櫻花茶館</h2>
        <div
          class="sakura-card p-6 flex flex-col items-center justify-center min-h-[450px]"
        >
          <div
            id="chat-display"
            class="w-full max-w-3xl h-80 overflow-y-auto p-4 mb-4 border border-pink-200 rounded-lg bg-white bg-opacity-70 shadow-inner"
          >
            <!-- Chat messages will be appended here -->
          </div>
          <div class="w-full max-w-3xl flex gap-4">
            <input
              type="text"
              id="user-chat-input"
              class="input-field flex-grow"
              placeholder="輸入您的日語對話..."
              disabled
            />
            <button class="btn-primary text-lg" id="send-chat-message" disabled>
              發送
            </button>
          </div>
          <p
            id="chat-status"
            class="text-sm text-pink-600 mt-2 h-5 font-semibold"
          ></p>
        </div>
      </section>

      <section id="progress-calendar" class="hidden">
        <h2 class="text-4xl section-title mb-8 text-center">我的學習歷程</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-2 sakura-card p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">
              學習日曆
            </h3>
            <div class="flex justify-between items-center mb-4">
              <button
                id="prev-month"
                class="p-2 rounded-full hover:bg-pink-100"
              >
                &lt;
              </button>
              <h4
                id="calendar-month-year"
                class="text-xl font-semibold text-pink-600"
              ></h4>
              <button
                id="next-month"
                class="p-2 rounded-full hover:bg-pink-100"
              >
                &gt;
              </button>
            </div>
            <div
              class="grid grid-cols-7 text-center font-bold text-gray-600 mb-2"
            >
              <span>日</span><span>一</span><span>二</span><span>三</span
              ><span>四</span><span>五</span><span>六</span>
            </div>
            <div id="calendar-grid" class="calendar-grid"></div>
          </div>
          <div class="sakura-card p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">
              五十音熟練度
            </h3>
            <canvas id="proficiency-chart"></canvas>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="w-full max-w-6xl text-center mt-12 text-gray-500 text-sm">
      &copy; 2025 屏實力數位服務有限公司 - 櫻花之路 2.0
    </footer>

    <!-- Modals -->
    <div id="settings-modal" class="modal-overlay">
      <div class="modal-content glass-morphism p-8 max-w-xl w-full relative">
        <button
          class="absolute top-4 right-4 text-gray-600 hover:text-pink-500"
          onclick="document.getElementById('settings-modal').classList.remove('active')"
        >
          &times;
        </button>
        <h2 class="text-3xl section-title mb-6 text-center">Gemini API 設定</h2>
        <p class="text-gray-700 mb-6 text-center">
          請輸入您的 Gemini API Key 以啟用 AI 對話功能。
        </p>
        <div class="mb-4">
          <label
            for="gemini-api-key"
            class="block text-gray-700 text-sm font-bold mb-2"
            >Gemini API Key:</label
          ><input
            type="password"
            id="gemini-api-key"
            class="input-field w-full"
            placeholder="在此輸入您的 API Key"
          />
        </div>
        <div class="flex gap-4 justify-center mb-4">
          <button class="btn-primary" id="test-api-connection">連接測試</button
          ><button class="btn-secondary" id="clear-api-key">清空</button>
        </div>
        <p id="api-status" class="text-center text-sm font-semibold mb-4 h-5">
          狀態: 未連接
        </p>
        <a
          href="https://aistudio.google.com/app/apikey"
          target="_blank"
          class="text-pink-500 hover:text-pink-700 text-center block"
          >如何取得 API Key？</a
        >
      </div>
    </div>

    <div id="login-modal" class="modal-overlay">
      <div
        class="modal-content glass-morphism p-8 max-w-sm w-full relative text-center"
      >
        <button
          class="absolute top-4 right-4 text-gray-600 hover:text-pink-500"
          onclick="document.getElementById('login-modal').classList.remove('active')"
        >
          &times;
        </button>
        <h2 class="text-3xl section-title mb-6 text-center">登入櫻花之路</h2>
        <p class="text-gray-700 mb-8">登入以同步您的學習進度！</p>
        <button
          id="google-login-button"
          class="btn-primary w-full flex items-center justify-center gap-3"
        >
          <svg class="w-6 h-6" viewBox="0 0 48 48">
            <path
              fill="#FFC107"
              d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
            ></path>
            <path
              fill="#FF3D00"
              d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
            ></path>
            <path
              fill="#4CAF50"
              d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
            ></path>
            <path
              fill="#1976D2"
              d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.021,35.596,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"
            ></path>
          </svg>
          使用 Google 登入
        </button>
      </div>
    </div>

    <div id="custom-alert-modal" class="modal-overlay">
      <div
        class="modal-content glass-morphism p-8 max-w-lg w-full relative text-center"
      >
        <h3 id="custom-alert-title" class="text-2xl section-title mb-4">
          提示
        </h3>
        <div id="custom-alert-message" class="text-gray-700 mb-6"></div>
        <button id="custom-alert-close" class="btn-primary">我知道了</button>
      </div>
    </div>

    <script type="module">
      // Firebase SDKs
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        signInAnonymously,
        onAuthStateChanged,
        signOut,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        setLogLevel,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- 全局狀態與變數 ---
      let hiraganaData = [];
      let geminiApiKey = localStorage.getItem("geminiApiKey") || "";
      let db, auth;
      let currentUser = null;
      let userProfile = null;
      let proficiencyChart = null;
      let currentMonth = new Date();
      let gameTimerInterval;
      let isAuthReady = false; // 用來追蹤 Firebase Auth 是否已準備就緒
      let chatHistory = [];
      let isChatInitialized = false;
      let crosswordState = {
        cells: [],
        activeClue: null,
        direction: "H",
      };

      const localHiraganaData = [
        { hiragana: "あ", romaji: "a", word: "朝 (asa)" },
        { hiragana: "い", romaji: "i", word: "犬 (inu)" },
        { hiragana: "う", romaji: "u", word: "海 (umi)" },
        { hiragana: "え", romaji: "e", word: "駅 (eki)" },
        { hiragana: "お", romaji: "o", word: "お金 (okane)" },
        { hiragana: "か", romaji: "ka", word: "傘 (kasa)" },
        { hiragana: "き", romaji: "ki", word: "木 (ki)" },
        { hiragana: "く", romaji: "ku", word: "靴 (kutsu)" },
        { hiragana: "け", romaji: "ke", word: "ケーキ (keeki)" },
        { hiragana: "こ", romaji: "ko", word: "子供 (kodomo)" },
        { hiragana: "さ", romaji: "sa", word: "魚 (sakana)" },
        { hiragana: "し", romaji: "shi", word: "写真 (shashin)" },
        { hiragana: "す", romaji: "su", word: "寿司 (sushi)" },
        { hiragana: "せ", romaji: "se", word: "世界 (sekai)" },
        { hiragana: "そ", romaji: "so", word: "空 (sora)" },
        { hiragana: "た", romaji: "ta", word: "卵 (tamago)" },
        { hiragana: "ち", romaji: "chi", word: "地下鉄 (chikatetsu)" },
        { hiragana: "つ", romaji: "tsu", word: "机 (tsukue)" },
        { hiragana: "て", romaji: "te", word: "手紙 (tegami)" },
        { hiragana: "と", romaji: "to", word: "時計 (tokei)" },
        { hiragana: "な", romaji: "na", word: "名前 (namae)" },
        { hiragana: "に", romaji: "ni", word: "日本語 (nihongo)" },
        { hiragana: "ぬ", romaji: "nu", word: "布 (nuno)" },
        { hiragana: "ね", romaji: "ne", word: "猫 (neko)" },
        { hiragana: "の", romaji: "no", word: "喉 (nodo)" },
        { hiragana: "は", romaji: "ha", word: "花 (hana)" },
        { hiragana: "ひ", romaji: "hi", word: "飛行機 (hikouki)" },
        { hiragana: "ふ", romaji: "fu", word: "富士山 (fujisan)" },
        { hiragana: "へ", romaji: "he", word: "部屋 (heya)" },
        { hiragana: "ほ", romaji: "ho", word: "本 (hon)" },
        { hiragana: "ま", romaji: "ma", word: "毎日 (mainichi)" },
        { hiragana: "み", romaji: "mi", word: "水 (mizu)" },
        { hiragana: "む", romaji: "mu", word: "虫 (mushi)" },
        { hiragana: "め", romaji: "me", word: "眼鏡 (megane)" },
        { hiragana: "も", romaji: "mo", word: "桃 (momo)" },
        { hiragana: "や", romaji: "ya", word: "山 (yama)" },
        { hiragana: "ゆ", romaji: "yu", word: "雪 (yuki)" },
        { hiragana: "よ", romaji: "yo", word: "夜 (yoru)" },
        { hiragana: "ら", romaji: "ra", word: "ラーメン (raamen)" },
        { hiragana: "り", romaji: "ri", word: "りんご (ringo)" },
        { hiragana: "る", romaji: "ru", word: "留守 (rusu)" },
        { hiragana: "れ", romaji: "re", word: "歴史 (rekishi)" },
        { hiragana: "ろ", romaji: "ro", word: "ろうそく (rousoku)" },
        { hiragana: "わ", romaji: "wa", word: "私 (watashi)" },
        { hiragana: "を", romaji: "wo", word: "〜を (助詞)" },
        { hiragana: "ん", romaji: "n", word: "新聞 (shinbun)" },
      ];

      // --- 函數定義 ---

      function showCustomAlert(title, message) {
        document.getElementById("custom-alert-title").textContent = title;
        const messageEl = document.getElementById("custom-alert-message");
        messageEl.innerHTML = ""; // Clear previous content

        const pre = document.createElement("pre");
        pre.textContent = message;
        messageEl.appendChild(pre);

        document.getElementById("custom-alert-modal").classList.add("active");
      }

      async function initializeFirebase() {
        try {
          // 優先使用 Canvas 環境提供的設定
          const firebaseConfig =
            typeof __firebase_config !== "undefined"
              ? JSON.parse(__firebase_config)
              : {
                  // 這是你原本的設定，作為備用
                  apiKey: "AIzaSyAty2H0pPyis6b5Vrc69JSWGYFBuxU3MRg",
                  authDomain: "learn-b4116.firebaseapp.com",
                  projectId: "learn-b4116",
                  storageBucket: "learn-b4116.appspot.com",
                  messagingSenderId: "146098029176",
                  appId: "1:146098029176:web:2489c7a3975aba57a4e38d",
                };

          const app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getFirestore(app);
          setLogLevel("debug"); // 開發時可以設為 debug 來看更多資訊
          return true;
        } catch (error) {
          console.error("Firebase 初始化失敗:", error);
          showCustomAlert(
            "初始化失敗",
            `無法連接至後端服務，部分功能將無法使用。\n錯誤訊息: ${error.message}`
          );
          return false;
        }
      }

      async function handleGoogleLogin() {
        if (!auth) {
          showCustomAlert("錯誤", "驗證服務尚未初始化，請稍後再試。");
          return;
        }
        const provider = new GoogleAuthProvider();
        try {
          await signInWithPopup(auth, provider);
          document.getElementById("login-modal").classList.remove("active");
        } catch (error) {
          console.error("Google 登入失敗:", error);
          if (error.code === "auth/unauthorized-domain") {
            showCustomAlert(
              "登入失敗",
              "這個網站的網域未被授權進行登入。請確認您已在 Firebase 控制台將此網域加入授權列表。"
            );
          } else {
            showCustomAlert("登入錯誤", `發生未知錯誤: ${error.message}`);
          }
        }
      }

      async function loadUserProfile(uid) {
        // 如果是匿名用戶，直接使用本地資料，不讀取 Firestore
        if (currentUser && currentUser.isAnonymous) {
          console.log("匿名用戶，使用本地資料。");
          userProfile = {
            name: "訪客",
            isAnonymous: true,
            progress: {},
            studyRecords: [],
          };
          hiraganaData = localHiraganaData.map((item) => ({
            ...item,
            proficiency: 0,
          }));
          return; // 直接返回，不執行後續的 Firestore 操作
        }

        const userProfileRef = doc(db, "users", uid);
        try {
          const userSnap = await getDoc(userProfileRef);
          if (userSnap.exists()) {
            userProfile = userSnap.data();
          } else {
            // 創建新的使用者資料
            userProfile = {
              name: currentUser.displayName || `使用者${uid.substring(0, 5)}`,
              email: currentUser.email || null,
              photoURL: currentUser.photoURL || null,
              isAnonymous: currentUser.isAnonymous,
              joinedDate: new Date().toISOString(),
              progress: {},
              studyRecords: [],
            };
            await setDoc(userProfileRef, userProfile);
          }
          // 將 Firestore 的進度合併到本地資料
          hiraganaData = localHiraganaData.map((item) => ({
            ...item,
            proficiency: userProfile.progress?.[item.hiragana] || 0,
          }));
        } catch (error) {
          console.error("讀取使用者資料失敗:", error);
          if (
            error.code === "permission-denied" ||
            error.code === "missing-or-insufficient-permissions"
          ) {
            const ruleText = `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 允許已登入的使用者讀寫自己的資料
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}`;
            showCustomAlert(
              "Firebase 權限錯誤 (非常重要!)",
              "讀取使用者資料失敗。這通常是因為您的 Firestore 安全規則不正確。\n\n" +
                "請依照以下步驟解決：\n" +
                "1. 前往 Firebase 控制台 > Firestore Database > Rules 分頁。\n" +
                "2. 刪除所有現有規則。\n" +
                "3. 將以下規則完整複製並貼上：\n\n" +
                ruleText +
                "\n\n" +
                "4. 點擊「發布 (Publish)」。\n" +
                "5. 重新整理此頁面。"
            );
          } else {
            showCustomAlert(
              "資料讀取錯誤",
              `無法讀取您的個人資料，將使用本機資料。\n錯誤: ${error.message}`
            );
          }
          // 發生錯誤時，退回使用本地資料
          userProfile = { name: "錯誤", progress: {}, studyRecords: [] };
          hiraganaData = localHiraganaData.map((item) => ({
            ...item,
            proficiency: 0,
          }));
        }
      }

      async function updateUserProgress(character, newProficiency) {
        if (!currentUser || currentUser.isAnonymous || !userProfile) return;

        const currentProficiency = userProfile.progress?.[character] || 0;
        if (newProficiency <= currentProficiency) return;

        // 更新本地狀態
        userProfile.progress[character] = newProficiency;
        const today = new Date().toISOString().split("T")[0];
        if (!userProfile.studyRecords.includes(today)) {
          userProfile.studyRecords.push(today);
        }
        const item = hiraganaData.find((h) => h.hiragana === character);
        if (item) item.proficiency = newProficiency;

        // 更新 UI
        renderHiraganaCards();
        renderProficiencyChart();

        // 更新 Firestore
        const userProfileRef = doc(db, "users", currentUser.uid);
        try {
          await updateDoc(userProfileRef, {
            progress: userProfile.progress,
            studyRecords: userProfile.studyRecords,
          });
        } catch (error) {
          console.error("更新進度失敗:", error);
          if (
            error.code === "permission-denied" ||
            error.code === "missing-or-insufficient-permissions"
          ) {
            showCustomAlert(
              "權限錯誤",
              "更新學習進度失敗。請確認您的 Firestore 安全規則已設定正確。"
            );
          }
        }
      }

      function handleLogout() {
        signOut(auth).catch((error) => console.error("登出失敗:", error));
      }

      function updateUIForAuthState() {
        const loginButton = document.getElementById("login-button");
        const userMenu = document.getElementById("user-menu");
        const chatInput = document.getElementById("user-chat-input");
        const sendChatBtn = document.getElementById("send-chat-message");

        if (currentUser && !currentUser.isAnonymous && userProfile) {
          loginButton.classList.add("hidden");
          userMenu.classList.remove("hidden");
          userMenu.classList.add("flex");
          document.getElementById("user-name").textContent =
            userProfile.name?.split(" ")[0] || "使用者";
          document.getElementById("user-avatar").src =
            userProfile.photoURL ||
            `https://placehold.co/40x40/E2E8F0/4A5568?text=${
              userProfile.name?.[0] || "U"
            }`;
          document.getElementById("user-avatar").onerror = () => {
            document.getElementById("user-avatar").src =
              "https://placehold.co/40x40/E2E8F0/4A5568?text=👤";
          };
        } else {
          loginButton.classList.remove("hidden");
          userMenu.classList.add("hidden");
          userMenu.classList.remove("flex");
        }

        if (geminiApiKey) {
          chatInput.disabled = false;
          sendChatBtn.disabled = false;
          document.getElementById("gemini-api-key").value = geminiApiKey;
          testApiKey(geminiApiKey, false); // 在載入時靜默測試
        } else {
          chatInput.disabled = true;
          sendChatBtn.disabled = true;
        }
      }

      function showSection(sectionId) {
        document
          .querySelectorAll("#main-content > section")
          .forEach((section) => section.classList.add("hidden"));
        document.getElementById(sectionId).classList.remove("hidden");
        document.querySelectorAll(".nav-link").forEach((button) => {
          button.classList.toggle(
            "active",
            button.dataset.section === sectionId
          );
        });
        if (sectionId === "progress-calendar") renderProgressSection();
        if (sectionId === "phrase-practice")
          switchPracticeView("practice-menu");
        if (sectionId === "ai-conversation" && !isChatInitialized) {
          initializeChat();
        }
      }

      function renderHiraganaCards() {
        const container = document.getElementById("hiragana-cards-container");
        container.innerHTML = "";
        if (!hiraganaData || hiraganaData.length === 0) return;
        const proficiencyColors = [
          "bg-white/60",
          "bg-pink-100",
          "bg-pink-200",
          "bg-yellow-100",
          "bg-green-100",
          "bg-gradient-to-br from-green-200 to-blue-200",
        ];
        hiraganaData.forEach((item) => {
          const card = document.createElement("div");
          card.className = `sakura-card p-4 text-center flex flex-col items-center justify-between cursor-pointer ${
            proficiencyColors[item.proficiency || 0]
          }`;
          card.innerHTML = `
                    <div class="text-6xl font-bold text-gray-800 font-['Noto_Sans_JP']">${item.hiragana}</div>
                    <div class="text-xl text-gray-600">${item.romaji}</div>
                    <div class="text-xs text-gray-500 mt-2">例: ${item.word}</div>
                `;
          card.addEventListener("click", () => {
            playSound(item.hiragana);
            updateUserProgress(
              item.hiragana,
              (item.proficiency || 0) + 1 > 5 ? 5 : (item.proficiency || 0) + 1
            );
          });
          container.appendChild(card);
        });
      }

      function playSound(text) {
        if ("speechSynthesis" in window) {
          window.speechSynthesis.cancel(); // 避免語音重疊
          const u = new SpeechSynthesisUtterance(text);
          u.lang = "ja-JP";
          u.rate = 0.9;
          window.speechSynthesis.speak(u);
        }
      }

      function switchPracticeView(viewId) {
        const practiceSection = document.getElementById("phrase-practice");
        practiceSection
          .querySelectorAll(":scope > div")
          .forEach((div) => div.classList.add("hidden"));
        document.getElementById(viewId).classList.remove("hidden");
      }

      function startDailyPractice() {
        switchPracticeView("daily-practice-interface");
        renderDailyCard();
      }
      function renderDailyCard() {
        if (hiraganaData.length === 0) return;
        const cardData =
          hiraganaData[Math.floor(Math.random() * hiraganaData.length)];
        const container = document.getElementById("daily-card-container");
        container.innerHTML = `
                <div class="text-8xl font-bold text-gray-800 font-['Noto_Sans_JP'] cursor-pointer">${cardData.hiragana}</div>
                <div class="mt-4 text-3xl text-gray-700">${cardData.romaji}</div>
                <p class="mt-2 text-xl text-gray-600">${cardData.word}</p>
                <button class="btn-primary mt-6" data-sound="${cardData.hiragana}">播放發音</button>
            `;
        container
          .querySelector("button")
          .addEventListener("click", (e) => playSound(e.target.dataset.sound));
      }

      let currentCorrectAnswer = "",
        score = 0,
        timer = 30;
      function startWordMatchGame() {
        switchPracticeView("word-match-game-interface");
        document
          .getElementById("game-question-area")
          .classList.remove("hidden");
        document.getElementById("game-over-area").classList.add("hidden");
        score = 0;
        timer = 30;
        document.getElementById("game-score").textContent = score;
        document.getElementById("game-timer").textContent = timer;
        generateNewQuestion();
        if (gameTimerInterval) clearInterval(gameTimerInterval);
        gameTimerInterval = setInterval(() => {
          timer--;
          document.getElementById("game-timer").textContent = timer;
          if (timer <= 0) endWordMatchGame();
        }, 1000);
      }
      function generateNewQuestion() {
        if (hiraganaData.length < 4) return;
        document.getElementById("game-feedback").textContent = "";
        const shuffled = [...hiraganaData].sort(() => 0.5 - Math.random());
        const options = shuffled.slice(0, 4);
        const questionItem = options[Math.floor(Math.random() * 4)];
        currentCorrectAnswer = questionItem.romaji;
        document.getElementById("game-question-word").textContent =
          questionItem.hiragana;
        const optionsContainer = document.getElementById(
          "game-options-container"
        );
        optionsContainer.innerHTML = "";
        options
          .sort(() => 0.5 - Math.random())
          .forEach((opt) => {
            const button = document.createElement("button");
            button.className =
              "game-option-button p-4 rounded-lg text-xl font-bold";
            button.textContent = opt.romaji;
            button.dataset.answer = opt.romaji;
            button.addEventListener("click", checkAnswer);
            optionsContainer.appendChild(button);
          });
      }
      function checkAnswer(event) {
        const selectedAnswer = event.target.dataset.answer;
        document
          .querySelectorAll("#game-options-container button")
          .forEach((btn) => (btn.disabled = true));
        const feedbackEl = document.getElementById("game-feedback");
        if (selectedAnswer === currentCorrectAnswer) {
          score++;
          document.getElementById("game-score").textContent = score;
          event.target.classList.add("correct");
          feedbackEl.textContent = "正確！";
          feedbackEl.className = "mt-4 h-6 text-lg font-bold text-green-600";
        } else {
          event.target.classList.add("incorrect");
          feedbackEl.textContent = `錯誤！答案是 ${currentCorrectAnswer}`;
          feedbackEl.className = "mt-4 h-6 text-lg font-bold text-red-600";
        }
        setTimeout(() => {
          if (timer > 0) generateNewQuestion();
        }, 1200);
      }
      function endWordMatchGame() {
        clearInterval(gameTimerInterval);
        document.getElementById("game-question-area").classList.add("hidden");
        const gameOverArea = document.getElementById("game-over-area");
        gameOverArea.classList.remove("hidden");
        document.getElementById("final-score").textContent = score;
      }

      function renderProgressSection() {
        renderCalendar();
        renderProficiencyChart();
      }
      function renderCalendar() {
        const grid = document.getElementById("calendar-grid");
        const monthYearEl = document.getElementById("calendar-month-year");
        grid.innerHTML = "";
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        monthYearEl.textContent = `${year}年 ${month + 1}月`;
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++)
          grid.appendChild(document.createElement("div"));
        for (let day = 1; day <= daysInMonth; day++) {
          const dayEl = document.createElement("div");
          dayEl.className =
            "calendar-day flex items-center justify-center text-gray-700";
          dayEl.textContent = day;
          const dateStr = `${year}-${String(month + 1).padStart(
            2,
            "0"
          )}-${String(day).padStart(2, "0")}`;
          if (userProfile?.studyRecords?.includes(dateStr)) {
            dayEl.classList.add("studied", "text-white");
          }
          grid.appendChild(dayEl);
        }
      }
      function renderProficiencyChart() {
        const ctx = document
          .getElementById("proficiency-chart")
          .getContext("2d");
        if (proficiencyChart) proficiencyChart.destroy();
        if (!hiraganaData || hiraganaData.length === 0) return;
        const levels = [0, 0, 0, 0, 0, 0]; // 0 to 5
        hiraganaData.forEach((item) => {
          const p = item.proficiency || 0;
          levels[p]++;
        });
        proficiencyChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["未學習", "初識", "入門", "熟悉", "熟練", "精通"],
            datasets: [
              {
                data: levels,
                backgroundColor: [
                  "#f3f4f6",
                  "#fce7f3",
                  "#fbcfe8",
                  "#f9a8d4",
                  "#93c5fd",
                  "#6ee7b7",
                ],
                borderColor: "rgba(255, 255, 255, 0.7)",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { position: "top" } },
          },
        });
      }

      // --- 和風填字遊戲相關函式 ---
      const sampleCrossword = {
        width: 5,
        height: 5,
        clues: [
          {
            id: 1,
            dir: "H",
            row: 0,
            col: 1,
            word: "ねこ",
            clue: "會喵喵叫的動物",
          },
          { id: 2, dir: "V", row: 0, col: 1, word: "なつ", clue: "夏天" },
          {
            id: 3,
            dir: "H",
            row: 2,
            col: 0,
            word: "さかな",
            clue: "在水裡游的",
          },
          {
            id: 4,
            dir: "V",
            row: 2,
            col: 4,
            word: "なまえ",
            clue: "你的...？ (Your Name)",
          },
          {
            id: 5,
            dir: "H",
            row: 4,
            col: 1,
            word: "いぬ",
            clue: "人類最好的朋友",
          },
        ],
      };

      function startCrosswordGame() {
        switchPracticeView("crossword-game-interface");
        renderCrossword(sampleCrossword);
      }

      function renderCrossword(puzzle) {
        const grid = document.getElementById("crossword-grid");
        const cluesContainer = document.getElementById("crossword-clues");
        grid.innerHTML = "";
        cluesContainer.innerHTML = "";

        grid.style.gridTemplateColumns = `repeat(${puzzle.width}, 40px)`;

        // 初始化二維陣列來存放儲存格元素和資訊
        crosswordState.cells = Array(puzzle.height)
          .fill(null)
          .map(() => Array(puzzle.width).fill(null));

        // 建立所有儲存格的容器
        for (let r = 0; r < puzzle.height; r++) {
          for (let c = 0; c < puzzle.width; c++) {
            const cellContainer = document.createElement("div");
            cellContainer.className = "crossword-cell-container";
            grid.appendChild(cellContainer);
            crosswordState.cells[r][c] = {
              container: cellContainer,
              input: null,
              clues: {},
            };
          }
        }

        // 填入謎題的儲存格
        puzzle.clues.forEach((clue) => {
          for (let i = 0; i < clue.word.length; i++) {
            let r = clue.row,
              c = clue.col;
            if (clue.dir === "H") c += i;
            else r += i;

            let cellInfo = crosswordState.cells[r][c];
            if (!cellInfo.input) {
              // 如果還沒有輸入框，就建立一個
              const input = document.createElement("input");
              input.type = "text";
              input.maxLength = 1;
              input.className = "crossword-cell";
              input.dataset.row = r;
              input.dataset.col = c;
              input.autocomplete = "off";

              cellInfo.container.appendChild(input);
              cellInfo.input = input;
              cellInfo.answer = "";
            }

            cellInfo.clues[clue.dir] = clue.id;
            if (i === 0) {
              const numberSpan = document.createElement("span");
              numberSpan.className = "crossword-number";
              numberSpan.textContent = clue.id;
              cellInfo.container.appendChild(numberSpan);
            }

            if (clue.dir === "H") cellInfo.answerH = clue.word[i];
            if (clue.dir === "V") cellInfo.answerV = clue.word[i];
          }
        });

        // 渲染提示列表並加入事件
        const sortedClues = [...puzzle.clues].sort((a, b) => a.id - b.id);
        sortedClues.forEach((clue) => {
          const clueEl = document.createElement("div");
          clueEl.className =
            "crossword-clue p-2 rounded-md cursor-pointer transition";
          clueEl.textContent = `${clue.id}. ${clue.clue} (${
            clue.dir === "H" ? "橫" : "直"
          })`;
          clueEl.dataset.clueId = clue.id;
          clueEl.dataset.dir = clue.dir;
          clueEl.addEventListener("click", () => {
            setActiveClue(clue.id, clue.dir);
            const startCell = crosswordState.cells[clue.row][clue.col];
            if (startCell && startCell.input) startCell.input.focus();
          });
          cluesContainer.appendChild(clueEl);
        });

        // 為所有輸入框加入事件監聽
        grid.querySelectorAll(".crossword-cell").forEach((input) => {
          input.addEventListener("input", handleCrosswordInput);
          input.addEventListener("keydown", handleCrosswordKeyDown);
          input.addEventListener("focus", handleCrosswordFocus);
        });
      }

      function setActiveClue(clueId, direction) {
        crosswordState.activeClue = clueId;
        crosswordState.direction = direction;

        // 更新提示列表的 highlight
        document.querySelectorAll(".crossword-clue").forEach((c) => {
          c.classList.toggle(
            "active",
            c.dataset.clueId == clueId && c.dataset.dir == direction
          );
        });

        // 更新格子的 highlight
        document.querySelectorAll(".crossword-cell").forEach((input) => {
          const r = parseInt(input.dataset.row);
          const c = parseInt(input.dataset.col);
          const cellInfo = crosswordState.cells[r][c];
          input.classList.toggle(
            "highlight",
            cellInfo && cellInfo.clues[direction] == clueId
          );
        });
      }

      function handleCrosswordFocus(e) {
        const r = parseInt(e.target.dataset.row);
        const c = parseInt(e.target.dataset.col);
        const cellInfo = crosswordState.cells[r][c];

        if (cellInfo.clues[crosswordState.direction]) {
          setActiveClue(
            cellInfo.clues[crosswordState.direction],
            crosswordState.direction
          );
        } else if (cellInfo.clues["H"]) {
          setActiveClue(cellInfo.clues["H"], "H");
        } else if (cellInfo.clues["V"]) {
          setActiveClue(cellInfo.clues["V"], "V");
        }
      }

      function handleCrosswordInput(e) {
        const r = parseInt(e.target.dataset.row);
        const c = parseInt(e.target.dataset.col);

        if (e.target.value) {
          let nextR = r,
            nextC = c;
          if (crosswordState.direction === "H") nextC++;
          else nextR++;

          if (
            nextR < crosswordState.cells.length &&
            nextC < crosswordState.cells[0].length
          ) {
            const nextCell = crosswordState.cells[nextR][nextC];
            if (nextCell && nextCell.input) {
              nextCell.input.focus();
            }
          }
        }
      }

      function handleCrosswordKeyDown(e) {
        const r = parseInt(e.target.dataset.row);
        const c = parseInt(e.target.dataset.col);
        let nextR = r,
          nextC = c;

        switch (e.key) {
          case "ArrowUp":
            e.preventDefault();
            nextR--;
            break;
          case "ArrowDown":
            e.preventDefault();
            nextR++;
            break;
          case "ArrowLeft":
            e.preventDefault();
            nextC--;
            break;
          case "ArrowRight":
            e.preventDefault();
            nextC++;
            break;
          case "Backspace":
            if (!e.target.value) {
              e.preventDefault();
              if (crosswordState.direction === "H") nextC--;
              else nextR--;
            }
            break;
        }

        if (
          nextR >= 0 &&
          nextR < crosswordState.cells.length &&
          nextC >= 0 &&
          nextC < crosswordState.cells[0].length
        ) {
          const nextCell = crosswordState.cells[nextR][nextC];
          if (nextCell && nextCell.input) {
            nextCell.input.focus();
          }
        }
      }

      function checkCrossword() {
        let allCorrect = true;
        let filledCount = 0;
        document.querySelectorAll(".crossword-cell").forEach((input) => {
          const r = parseInt(input.dataset.row);
          const c = parseInt(input.dataset.col);
          const cellInfo = crosswordState.cells[r][c];
          const answer =
            (crosswordState.direction === "H"
              ? cellInfo.answerH
              : cellInfo.answerV) ||
            cellInfo.answerH ||
            cellInfo.answerV;

          input.classList.remove("correct", "incorrect");
          if (input.value) {
            filledCount++;
            if (input.value === answer) {
              input.classList.add("correct");
            } else {
              input.classList.add("incorrect");
              allCorrect = false;
            }
          } else {
            allCorrect = false; // 有空格就不算全部正確
          }
        });

        if (allCorrect && filledCount > 0) {
          showCustomAlert("恭喜！", "🎉 你完成了所有的謎題！太棒了！");
        } else if (filledCount > 0) {
          showCustomAlert(
            "再加把勁！",
            "有些答案不對喔，看看那些紅色的格子吧！"
          );
        } else {
          showCustomAlert("提示", "請先試著填寫答案喔！");
        }
      }

      async function testApiKey(key, showAlert = true) {
        const statusEl = document.getElementById("api-status");
        if (!key) {
          if (showAlert) {
            statusEl.textContent = "狀態: 請輸入 API Key";
            statusEl.className =
              "text-center text-sm font-semibold text-red-500 h-5";
          }
          return false;
        }
        statusEl.textContent = "狀態: 測試中...";
        statusEl.className =
          "text-center text-sm font-semibold text-orange-500 h-5";
        try {
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`;
          const response = await fetch(apiUrl, {
            method: "POST",
            body: JSON.stringify({
              contents: [{ parts: [{ text: "Hello" }] }],
            }),
          });
          if (response.ok) {
            statusEl.textContent = "狀態: 連接成功！";
            statusEl.className =
              "text-center text-sm font-semibold text-green-600 h-5";
            if (showAlert)
              showCustomAlert("成功", "API Key 測試成功，AI 對話功能已啟用！");
            return true;
          } else {
            const error = await response.json();
            statusEl.textContent = `狀態: 連接失敗`;
            statusEl.className =
              "text-center text-sm font-semibold text-red-500 h-5";
            if (showAlert)
              showCustomAlert(
                "連接失敗",
                `API Key 無法使用。\n錯誤: ${error.error.message}`
              );
            return false;
          }
        } catch (error) {
          statusEl.textContent = "狀態: 網路錯誤";
          statusEl.className =
            "text-center text-sm font-semibold text-red-500 h-5";
          if (showAlert)
            showCustomAlert(
              "網路錯誤",
              `無法連接至 Google API 服務，請檢查您的網路連線。`
            );
          return false;
        }
      }

      // --- AI 對話相關函式 ---
      function initializeChat() {
        chatHistory = [
          {
            role: "user",
            parts: [
              {
                text: "你現在是一位親切、友善的日語學習夥伴，名叫「櫻」。請用繁體中文和簡單的日語與我對話，鼓勵我練習。我們的對話從現在開始。",
              },
            ],
          },
          {
            role: "model",
            parts: [
              {
                text: "こんにちは！我是櫻 (Sakura)，你的專屬日語學習夥伴！很高興認識你～ 準備好一起練習日文了嗎？どんなことでも聞いてくださいね！(什麼事都可以問我喔！)",
              },
            ],
          },
        ];

        const chatDisplay = document.getElementById("chat-display");
        chatDisplay.innerHTML = ""; // 清空預設訊息
        appendChatMessage("model", chatHistory[1].parts[0].text);
        isChatInitialized = true;
      }

      function appendChatMessage(role, text) {
        const chatDisplay = document.getElementById("chat-display");
        const messageWrapper = document.createElement("div");
        const messageBubble = document.createElement("div");

        messageBubble.textContent = text;
        messageBubble.className =
          "p-3 rounded-lg max-w-xs lg:max-w-md break-words shadow";

        if (role === "user") {
          messageWrapper.className = "flex justify-end mb-4";
          messageBubble.classList.add("bg-pink-200", "text-gray-800");
        } else if (role === "model") {
          messageWrapper.className = "flex justify-start mb-4";
          messageBubble.classList.add("bg-white", "text-gray-800");
        } else {
          // error
          messageWrapper.className = "flex justify-center mb-4";
          messageBubble.classList.add(
            "bg-red-100",
            "text-red-700",
            "border",
            "border-red-300",
            "w-full"
          );
        }

        messageWrapper.appendChild(messageBubble);
        chatDisplay.appendChild(messageWrapper);
        chatDisplay.scrollTop = chatDisplay.scrollHeight; // 自動滾動到底部
      }

      async function sendChatMessage() {
        const inputEl = document.getElementById("user-chat-input");
        const statusEl = document.getElementById("chat-status");
        const sendBtn = document.getElementById("send-chat-message");

        const userMessage = inputEl.value.trim();
        if (!userMessage) return;

        if (!geminiApiKey) {
          showCustomAlert("錯誤", "請先在設定中輸入有效的 Gemini API Key。");
          return;
        }

        // 禁用輸入並顯示讀取狀態
        inputEl.value = "";
        inputEl.disabled = true;
        sendBtn.disabled = true;
        statusEl.textContent = "櫻 AI 思考中...";

        // 顯示使用者訊息
        appendChatMessage("user", userMessage);

        // 加入歷史紀錄
        chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

        try {
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
          const payload = {
            contents: chatHistory,
          };

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error.message || `HTTP 錯誤! 狀態碼: ${response.status}`
            );
          }

          const result = await response.json();
          const aiResponse = result.candidates[0].content.parts[0].text;

          // 顯示 AI 訊息
          appendChatMessage("model", aiResponse);

          // 將 AI 回覆加入歷史紀錄
          chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
        } catch (error) {
          console.error("AI 對話錯誤:", error);
          appendChatMessage("error", `糟糕，對話出錯了：\n${error.message}`);
          // 發生錯誤時，從歷史紀錄中移除最後一筆使用者訊息，以便重試
          chatHistory.pop();
        } finally {
          // 重新啟用輸入
          inputEl.disabled = false;
          sendBtn.disabled = false;
          statusEl.textContent = "";
          inputEl.focus();
        }
      }

      function setupEventListeners() {
        document
          .querySelectorAll(".nav-link")
          .forEach((button) =>
            button.addEventListener("click", () =>
              showSection(button.dataset.section)
            )
          );
        document
          .getElementById("login-button")
          .addEventListener("click", () =>
            document.getElementById("login-modal").classList.add("active")
          );
        document
          .getElementById("google-login-button")
          .addEventListener("click", handleGoogleLogin);
        document
          .getElementById("logout-button")
          .addEventListener("click", handleLogout);
        document
          .getElementById("settings-button")
          .addEventListener("click", () =>
            document.getElementById("settings-modal").classList.add("active")
          );
        document
          .getElementById("settings-modal")
          .addEventListener("click", (e) => {
            if (e.target === e.currentTarget)
              e.currentTarget.classList.remove("active");
          });
        document
          .getElementById("login-modal")
          .addEventListener("click", (e) => {
            if (e.target === e.currentTarget)
              e.currentTarget.classList.remove("active");
          });
        document
          .getElementById("custom-alert-close")
          .addEventListener("click", () =>
            document
              .getElementById("custom-alert-modal")
              .classList.remove("active")
          );

        document
          .getElementById("test-api-connection")
          .addEventListener("click", async () => {
            const key = document.getElementById("gemini-api-key").value.trim();
            const success = await testApiKey(key);
            if (success) {
              geminiApiKey = key;
              localStorage.setItem("geminiApiKey", key);
              document.getElementById("user-chat-input").disabled = false;
              document.getElementById("send-chat-message").disabled = false;
            }
          });

        document
          .getElementById("clear-api-key")
          .addEventListener("click", () => {
            document.getElementById("gemini-api-key").value = "";
            geminiApiKey = "";
            localStorage.removeItem("geminiApiKey");
            document.getElementById("api-status").textContent = "狀態: 已清空";
            document.getElementById("user-chat-input").disabled = true;
            document.getElementById("send-chat-message").disabled = true;
          });

        // AI Chat Listeners
        document
          .getElementById("send-chat-message")
          .addEventListener("click", sendChatMessage);
        document
          .getElementById("user-chat-input")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.target.disabled) {
              sendChatMessage();
            }
          });

        // Game Listeners
        document.querySelectorAll("[data-practice]").forEach((button) => {
          button.addEventListener("click", (e) => {
            const practiceType = e.currentTarget.dataset.practice;
            if (practiceType === "daily-practice") startDailyPractice();
            else if (practiceType === "word-match-game") startWordMatchGame();
            else if (practiceType === "crossword-game") startCrosswordGame();
          });
        });
        document.querySelectorAll(".back-to-menu").forEach((button) =>
          button.addEventListener("click", () => {
            clearInterval(gameTimerInterval);
            switchPracticeView("practice-menu");
          })
        );
        document
          .getElementById("next-daily-card")
          .addEventListener("click", renderDailyCard);
        document
          .getElementById("restart-word-match-game")
          .addEventListener("click", startWordMatchGame);
        document
          .getElementById("check-crossword-btn")
          .addEventListener("click", checkCrossword);
        document.getElementById("prev-month").addEventListener("click", () => {
          currentMonth.setMonth(currentMonth.getMonth() - 1);
          renderCalendar();
        });
        document.getElementById("next-month").addEventListener("click", () => {
          currentMonth.setMonth(currentMonth.getMonth() + 1);
          renderCalendar();
        });
      }

      function showContent() {
        document.getElementById("loading-state").classList.add("hidden");
        showSection("pronunciation-teaching");
      }

      // --- 主執行流程 ---
      async function main() {
        setupEventListeners();

        // 解決行動裝置語音問題：在首次使用者互動時「預熱」語音引擎
        const warmUpSpeech = () => {
          if ("speechSynthesis" in window) {
            // 播放一個無聲的內容來初始化/喚醒語音引擎
            window.speechSynthesis.speak(new SpeechSynthesisUtterance(""));
          }
        };
        // 使用 { once: true } 來確保這個事件只會被觸發一次
        document.body.addEventListener("click", warmUpSpeech, { once: true });
        document.body.addEventListener("touchend", warmUpSpeech, {
          once: true,
        });

        const firebaseReady = await initializeFirebase();

        if (!firebaseReady) {
          // Firebase 初始化徹底失敗，只能用本地模式
          userProfile = { name: "訪客 (離線)", progress: {}, studyRecords: [] };
          hiraganaData = localHiraganaData.map((h) => ({
            ...h,
            proficiency: 0,
          }));
          updateUIForAuthState();
          renderHiraganaCards();
          renderProgressSection();
          showContent();
          return;
        }

        onAuthStateChanged(auth, async (user) => {
          currentUser = user;
          if (user) {
            await loadUserProfile(user.uid);
          } else {
            // 如果使用者登出，或初始狀態為空，自動轉為匿名登入
            try {
              await signInAnonymously(auth);
              // 匿名登入後 onAuthStateChanged 會再次觸發，
              // 屆時 user 物件就會存在，並進入上面的 if 區塊
              return; // 避免執行後續的 UI 更新
            } catch (error) {
              console.error("匿名登入失敗:", error);
              // 匿名登入也失敗，只能用本地模式
              userProfile = {
                name: "訪客 (離線)",
                progress: {},
                studyRecords: [],
              };
              hiraganaData = localHiraganaData.map((h) => ({
                ...h,
                proficiency: 0,
              }));
            }
          }

          updateUIForAuthState();
          renderHiraganaCards();
          renderProgressSection();
          if (!isAuthReady) {
            showContent();
            isAuthReady = true;
          }
        });

        // 處理 Canvas 環境的自動登入
        try {
          if (
            typeof __initial_auth_token !== "undefined" &&
            __initial_auth_token
          ) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else if (!auth.currentUser) {
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error("初始登入失敗:", error);
          if (!auth.currentUser) {
            await signInAnonymously(auth);
          }
        }
      }

      // --- 啟動應用 ---
      main();
    </script>
  </body>
</html>
