<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ«»èŠ±ä¹‹è·¯ 2.0 - æ—¥æœ¬äº”åéŸ³å­¸ç¿’éŠæˆ²</title>
    <!-- Favicon -->
    <link rel="icon" href="./images/icon.png" type="image/png" />

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700;900&display=swap"
      rel="stylesheet"
    />
    <!-- Chart.js for progress charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      /* --- å…¨å±€èˆ‡æ«»èŠ±ä¸»é¡Œæ¨£å¼ --- */
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
        background: linear-gradient(135deg, #fff0f5 0%, #ffe4e1 100%);
      }

      /* Glass Morphism æ•ˆæœ */
      .glass-morphism {
        background-color: rgba(255, 255, 255, 0.55);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px 0 rgba(200, 100, 135, 0.2);
        border-radius: 1.5rem;
      }

      /* æ«»èŠ±å¡ç‰‡æ¨£å¼ */
      .sakura-card {
        background-color: rgba(255, 255, 255, 0.65);
        border-radius: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.4);
      }
      .sakura-card:hover {
        transform: translateY(-10px) scale(1.03);
        box-shadow: 0 12px 24px rgba(255, 105, 180, 0.2);
      }

      /* ä¸»æŒ‰éˆ• */
      .btn-primary {
        background: linear-gradient(135deg, #ff9a9e, #fecfef);
        color: white;
        border-radius: 0.75rem;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 15px rgba(255, 154, 158, 0.4);
        transition: all 0.3s ease;
        border: none;
      }
      .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(255, 154, 158, 0.6);
      }
      .btn-primary:disabled {
        background: #d1d5db;
        box-shadow: none;
        cursor: not-allowed;
      }

      /* æ¬¡è¦æŒ‰éˆ• */
      .btn-secondary {
        background-color: #fff;
        color: #ff69b4;
        border: 2px solid #ff9a9e;
        border-radius: 0.75rem;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }
      .btn-secondary:hover {
        background-color: #ff9a9e;
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(255, 154, 158, 0.4);
      }

      /* å°è¦½é€£çµ */
      .nav-link {
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        transition: all 0.3s ease-in-out;
        font-weight: 600;
        color: #4a5568;
        background-color: rgba(255, 255, 255, 0.4);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      .nav-link.active {
        background: linear-gradient(45deg, #ff6b6b, #ff9a9e);
        color: white;
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        transform: scale(1.05);
      }
      .nav-link:hover:not(.active) {
        background-color: rgba(255, 255, 255, 0.8);
        color: #ff69b4;
      }

      /* æ¨™é¡Œ */
      .section-title {
        background: linear-gradient(to right, #ff69b4, #c71585);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 900;
        font-family: "Noto Sans JP", sans-serif;
      }

      /* è¼¸å…¥æ¡† */
      .input-field {
        background-color: rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(255, 182, 193, 0.8);
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
        color: #4a5568;
        outline: none;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }
      .input-field:focus {
        border-color: #ff69b4;
        box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.3);
      }

      /* å½ˆå‡ºå¼è¦–çª— (Modal) */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }
      .modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }
      .modal-content {
        transform: scale(0.95);
        transition: transform 0.3s ease;
      }
      .modal-overlay.active .modal-content {
        transform: scale(1);
      }

      /* éŠæˆ²å°ˆç”¨æ¨£å¼ */
      .game-option-button {
        background: white;
        border: 2px solid #ffc0cb;
        color: #db2777;
        transition: all 0.2s ease-in-out;
      }
      .game-option-button:hover {
        transform: scale(1.05);
        background: #fbcfe8;
        border-color: #f472b6;
      }
      .game-option-button.correct {
        background: #a7f3d0;
        border-color: #10b981;
      }
      .game-option-button.incorrect {
        background: #fecaca;
        border-color: #ef4444;
      }

      /* å’Œé¢¨å¡«å­—éŠæˆ²æ¨£å¼ */
      #crossword-grid {
        display: grid;
        gap: 2px;
        position: relative;
      }
      .crossword-cell-container {
        position: relative;
        width: 40px;
        height: 40px;
      }
      .crossword-number {
        position: absolute;
        top: 1px;
        left: 2px;
        font-size: 0.6rem;
        font-weight: bold;
        color: #a855f7;
      }
      .crossword-cell {
        width: 100%;
        height: 100%;
        text-align: center;
        font-size: 1.5rem;
        border: 1px solid #ffc0cb;
        background-color: white;
        border-radius: 4px;
        caret-color: #ff69b4;
        text-transform: uppercase;
        font-family: "Noto Sans JP", sans-serif;
      }
      .crossword-cell:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.5);
        z-index: 10;
      }
      .crossword-cell.highlight {
        background-color: #fbcfe8;
      }
      .crossword-cell.correct {
        background-color: #dcfce7;
        color: #166534;
        font-weight: bold;
        animation: bounce 0.5s;
      }
      .crossword-cell.incorrect {
        background-color: #fee2e2;
        color: #991b1b;
        animation: shake 0.5s;
      }
      .crossword-clue {
        transition: background-color 0.2s;
      }
      .crossword-clue.active {
        background-color: #ffe4e1;
        border-radius: 0.5rem;
      }
      @keyframes bounce {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      /* å­¸ç¿’æ—¥æ›†æ¨£å¼ */
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }
      .calendar-day {
        aspect-ratio: 1 / 1;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        transition: all 0.2s;
      }
      .calendar-day.studied {
        background: linear-gradient(135deg, #ff9a9e, #fecfef);
        box-shadow: 0 2px 8px rgba(255, 154, 158, 0.5);
      }

      /* æç¤ºè¨Šæ¯æ¨£å¼ */
      #custom-alert-message {
        white-space: pre-wrap;
        text-align: left;
        background-color: rgba(255, 228, 225, 0.5);
        padding: 1rem;
        border-radius: 0.5rem;
        font-family: monospace;
        font-size: 0.875rem;
        max-height: 50vh;
        overflow-y: auto;
      }
    </style>
  </head>
  <body
    class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8"
  >
    <!-- Header Section -->
    <header
      class="w-full max-w-6xl mb-8 sm:mb-12 flex items-center justify-between px-4"
    >
      <!-- Left side: Logo and Title -->
      <div class="flex items-center gap-3 sm:gap-4 overflow-hidden">
        <img
          src="./images/pip.png"
          alt="Logo"
          class="h-8 sm:h-12 object-contain flex-shrink-0"
        />
        <div class="overflow-hidden">
          <h1
            class="text-xl sm:text-4xl font-extrabold tracking-tight section-title whitespace-nowrap"
          >
            æ«»èŠ±ä¹‹è·¯
          </h1>
          <p class="hidden sm:block text-pink-500 text-sm font-semibold">
            (Sakura no Michi)
          </p>
        </div>
      </div>
      <!-- Right side: User Actions -->
      <div
        id="user-actions"
        class="flex items-center gap-2 sm:gap-4 flex-shrink-0"
      >
        <button
          id="login-button"
          class="btn-secondary text-sm sm:text-base whitespace-nowrap"
        >
          ç™»å…¥
        </button>
        <div id="user-menu" class="hidden items-center gap-3">
          <span
            id="user-name"
            class="font-semibold text-gray-700 hidden sm:block"
          ></span>
          <img
            id="user-avatar"
            class="h-8 w-8 sm:h-10 sm:w-10 rounded-md cursor-pointer object-cover"
            alt="User Avatar"
          />
          <button
            id="logout-button"
            class="p-2 rounded-full hover:bg-white/50 transition-colors"
            title="ç™»å‡º"
          >
            <svg
              class="w-6 h-6 text-red-500"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
              />
            </svg>
          </button>
        </div>
        <button
          id="settings-button"
          class="p-2 sm:p-3 rounded-full hover:bg-white/50 transition-colors"
          title="API è¨­å®š"
        >
          <svg
            class="h-6 w-6 text-pink-500"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            />
          </svg>
        </button>
      </div>
    </header>

    <!-- Main Navigation -->
    <nav
      class="w-full max-w-4xl glass-morphism p-4 mb-12 flex flex-wrap justify-center gap-4"
    >
      <button class="nav-link active" data-section="pronunciation-teaching">
        ç™¼éŸ³æ•™å­¸
      </button>
      <button class="nav-link" data-section="phrase-practice">è©å¥ç·´ç¿’</button>
      <button class="nav-link" data-section="ai-conversation">AI å°è©±</button>
      <button class="nav-link" data-section="progress-calendar">
        å­¸ç¿’æ­·ç¨‹
      </button>
    </nav>

    <!-- Main Content -->
    <main id="main-content" class="w-full max-w-6xl glass-morphism p-6 md:p-8">
      <!-- Loading State -->
      <div id="loading-state" class="text-center py-16">
        <h2 class="text-2xl font-semibold text-pink-500 animate-pulse">
          è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...
        </h2>
      </div>

      <!-- Sections will be dynamically shown/hidden here -->
      <section id="pronunciation-teaching" class="hidden">
        <h2 class="text-4xl section-title mb-8 text-center">äº”åéŸ³ç™¼éŸ³æ•™å­¸</h2>
        <div
          id="hiragana-cards-container"
          class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6"
        ></div>
      </section>

      <section id="phrase-practice" class="hidden">
        <!-- This section now acts as a container for the menu and games -->
        <div id="practice-menu">
          <h2 class="text-4xl section-title mb-8 text-center">è©å¥ç·´ç¿’</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="sakura-card p-6 text-center flex flex-col">
              <h3 class="text-2xl font-bold text-gray-800 mb-4">æ¯æ—¥ç·´ç¿’å¡</h3>
              <p class="text-gray-700 mb-4 flex-grow">
                æ¯æ—¥ä¸€å¡ï¼Œè¼•é¬†éå›ºæ‚¨çš„æ—¥èªåŸºç¤ï¼
              </p>
              <button
                class="btn-primary mt-auto"
                data-practice="daily-practice"
              >
                é–‹å§‹ç·´ç¿’
              </button>
            </div>
            <div class="sakura-card p-6 text-center flex flex-col">
              <h3 class="text-2xl font-bold text-gray-800 mb-4">
                æ«»èŠ±å–®å­—é…å°
              </h3>
              <p class="text-gray-700 mb-4 flex-grow">
                è¨ˆæ™‚æŒ‘æˆ°ï¼åœ¨é£›èˆçš„æ«»èŠ±ä¸­é¸å‡ºæ­£ç¢ºè®€éŸ³ã€‚
              </p>
              <button
                class="btn-secondary mt-auto"
                data-practice="word-match-game"
              >
                é–‹å§‹éŠæˆ²
              </button>
            </div>
            <div class="sakura-card p-6 text-center flex flex-col">
              <h3 class="text-2xl font-bold text-gray-800 mb-4">å’Œé¢¨å¡«å­—</h3>
              <p class="text-gray-700 mb-4 flex-grow">
                æŒ‘æˆ°ä½ çš„è©å½™é‡ï¼Œå®Œæˆæ—¥å¼å¡«å­—è¬é¡Œã€‚
              </p>
              <button
                class="btn-secondary mt-auto"
                data-practice="crossword-game"
              >
                é–‹å§‹éŠæˆ²
              </button>
            </div>
          </div>
        </div>

        <!-- Daily Practice Interface -->
        <div id="daily-practice-interface" class="hidden text-center">
          <h2 class="text-3xl section-title mb-6">æ¯æ—¥ç·´ç¿’å¡</h2>
          <div
            id="daily-card-container"
            class="sakura-card max-w-md mx-auto p-8 min-h-[300px] flex flex-col justify-center items-center"
          ></div>
          <div class="mt-6 flex justify-center gap-4">
            <button class="btn-secondary back-to-menu">è¿”å›é¸å–®</button>
            <button id="next-daily-card" class="btn-primary">ä¸‹ä¸€å¼µ</button>
          </div>
        </div>

        <!-- Sakura Word Match Game Interface -->
        <div id="word-match-game-interface" class="hidden">
          <h2 class="text-4xl section-title mb-4 text-center">æ«»èŠ±å–®å­—é…å°</h2>
          <div
            class="flex justify-between items-center max-w-lg mx-auto mb-4 text-xl font-bold text-gray-700"
          >
            <div>
              æ™‚é–“: <span id="game-timer" class="text-pink-500">30</span>s
            </div>
            <div>
              å¾—åˆ†: <span id="game-score" class="text-pink-500">0</span>
            </div>
          </div>
          <div class="sakura-card max-w-lg mx-auto p-8 text-center">
            <div id="game-question-area">
              <p class="text-2xl text-gray-600 mb-4">
                è«‹é¸æ“‡ã€Œ<span
                  id="game-question-word"
                  class="font-bold text-fuchsia-700"
                ></span
                >ã€çš„æ­£ç¢ºè®€éŸ³ï¼š
              </p>
              <div
                id="game-options-container"
                class="grid grid-cols-2 gap-4"
              ></div>
            </div>
            <div id="game-over-area" class="hidden">
              <h3 class="text-3xl font-bold text-pink-600 mb-4">æ™‚é–“åˆ°ï¼</h3>
              <p class="text-xl text-gray-700">æ‚¨çš„æœ€çµ‚å¾—åˆ†æ˜¯ï¼š</p>
              <p
                id="final-score"
                class="text-6xl font-bold text-fuchsia-700 my-4"
              >
                0
              </p>
              <button id="restart-word-match-game" class="btn-primary">
                å†ç©ä¸€æ¬¡
              </button>
            </div>
            <div id="game-feedback" class="mt-4 h-6 text-lg font-bold"></div>
          </div>
          <div class="mt-6 text-center">
            <button class="btn-secondary back-to-menu">è¿”å›é¸å–®</button>
          </div>
        </div>

        <!-- Crossword Game Interface -->
        <div id="crossword-game-interface" class="hidden">
          <h2 class="text-4xl section-title mb-8 text-center">å’Œé¢¨å¡«å­—</h2>
          <div class="flex flex-col lg:flex-row gap-8 items-start">
            <div class="flex-grow sakura-card p-6 flex justify-center">
              <div id="crossword-grid"></div>
            </div>
            <div class="lg:w-1/3 sakura-card p-6 w-full">
              <h3 class="text-2xl font-bold text-gray-800 mb-4">æç¤º</h3>
              <div
                id="crossword-clues"
                class="space-y-2 max-h-60 overflow-y-auto"
              ></div>
              <button id="check-crossword-btn" class="btn-primary w-full mt-6">
                æª¢æŸ¥ç­”æ¡ˆ
              </button>
              <button class="btn-secondary w-full mt-3 back-to-menu">
                è¿”å›é¸å–®
              </button>
            </div>
          </div>
        </div>
      </section>

      <section id="ai-conversation" class="hidden">
        <h2 class="text-4xl section-title mb-8 text-center">AI æ«»èŠ±èŒ¶é¤¨</h2>
        <div
          class="sakura-card p-6 flex flex-col items-center justify-center min-h-[450px]"
        >
          <div
            id="chat-display"
            class="w-full max-w-3xl h-80 overflow-y-auto p-4 mb-4 border border-pink-200 rounded-lg bg-white bg-opacity-70 shadow-inner"
          >
            <!-- Chat messages will be appended here -->
          </div>
          <div class="w-full max-w-3xl flex gap-4">
            <input
              type="text"
              id="user-chat-input"
              class="input-field flex-grow"
              placeholder="è¼¸å…¥æ‚¨çš„æ—¥èªå°è©±..."
              disabled
            />
            <button class="btn-primary text-lg" id="send-chat-message" disabled>
              ç™¼é€
            </button>
          </div>
          <p
            id="chat-status"
            class="text-sm text-pink-600 mt-2 h-5 font-semibold"
          ></p>
        </div>
      </section>

      <section id="progress-calendar" class="hidden">
        <h2 class="text-4xl section-title mb-8 text-center">æˆ‘çš„å­¸ç¿’æ­·ç¨‹</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-2 sakura-card p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">
              å­¸ç¿’æ—¥æ›†
            </h3>
            <div class="flex justify-between items-center mb-4">
              <button
                id="prev-month"
                class="p-2 rounded-full hover:bg-pink-100"
              >
                &lt;
              </button>
              <h4
                id="calendar-month-year"
                class="text-xl font-semibold text-pink-600"
              ></h4>
              <button
                id="next-month"
                class="p-2 rounded-full hover:bg-pink-100"
              >
                &gt;
              </button>
            </div>
            <div
              class="grid grid-cols-7 text-center font-bold text-gray-600 mb-2"
            >
              <span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span
              ><span>å››</span><span>äº”</span><span>å…­</span>
            </div>
            <div id="calendar-grid" class="calendar-grid"></div>
          </div>
          <div class="sakura-card p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">
              äº”åéŸ³ç†Ÿç·´åº¦
            </h3>
            <canvas id="proficiency-chart"></canvas>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="w-full max-w-6xl text-center mt-12 text-gray-500 text-sm">
      &copy; 2025 å±å¯¦åŠ›æ•¸ä½æœå‹™æœ‰é™å…¬å¸ - æ«»èŠ±ä¹‹è·¯ 2.0
    </footer>

    <!-- Modals -->
    <div id="settings-modal" class="modal-overlay">
      <div class="modal-content glass-morphism p-8 max-w-xl w-full relative">
        <button
          class="absolute top-4 right-4 text-gray-600 hover:text-pink-500"
          onclick="document.getElementById('settings-modal').classList.remove('active')"
        >
          &times;
        </button>
        <h2 class="text-3xl section-title mb-6 text-center">Gemini API è¨­å®š</h2>
        <p class="text-gray-700 mb-6 text-center">
          è«‹è¼¸å…¥æ‚¨çš„ Gemini API Key ä»¥å•Ÿç”¨ AI å°è©±åŠŸèƒ½ã€‚
        </p>
        <div class="mb-4">
          <label
            for="gemini-api-key"
            class="block text-gray-700 text-sm font-bold mb-2"
            >Gemini API Key:</label
          ><input
            type="password"
            id="gemini-api-key"
            class="input-field w-full"
            placeholder="åœ¨æ­¤è¼¸å…¥æ‚¨çš„ API Key"
          />
        </div>
        <div class="flex gap-4 justify-center mb-4">
          <button class="btn-primary" id="test-api-connection">é€£æ¥æ¸¬è©¦</button
          ><button class="btn-secondary" id="clear-api-key">æ¸…ç©º</button>
        </div>
        <p id="api-status" class="text-center text-sm font-semibold mb-4 h-5">
          ç‹€æ…‹: æœªé€£æ¥
        </p>
        <a
          href="https://aistudio.google.com/app/apikey"
          target="_blank"
          class="text-pink-500 hover:text-pink-700 text-center block"
          >å¦‚ä½•å–å¾— API Keyï¼Ÿ</a
        >
      </div>
    </div>

    <div id="login-modal" class="modal-overlay">
      <div
        class="modal-content glass-morphism p-8 max-w-sm w-full relative text-center"
      >
        <button
          class="absolute top-4 right-4 text-gray-600 hover:text-pink-500"
          onclick="document.getElementById('login-modal').classList.remove('active')"
        >
          &times;
        </button>
        <h2 class="text-3xl section-title mb-6 text-center">ç™»å…¥æ«»èŠ±ä¹‹è·¯</h2>
        <p class="text-gray-700 mb-8">ç™»å…¥ä»¥åŒæ­¥æ‚¨çš„å­¸ç¿’é€²åº¦ï¼</p>
        <button
          id="google-login-button"
          class="btn-primary w-full flex items-center justify-center gap-3"
        >
          <svg class="w-6 h-6" viewBox="0 0 48 48">
            <path
              fill="#FFC107"
              d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
            ></path>
            <path
              fill="#FF3D00"
              d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
            ></path>
            <path
              fill="#4CAF50"
              d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
            ></path>
            <path
              fill="#1976D2"
              d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.021,35.596,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"
            ></path>
          </svg>
          ä½¿ç”¨ Google ç™»å…¥
        </button>
      </div>
    </div>

    <div id="custom-alert-modal" class="modal-overlay">
      <div
        class="modal-content glass-morphism p-8 max-w-lg w-full relative text-center"
      >
        <h3 id="custom-alert-title" class="text-2xl section-title mb-4">
          æç¤º
        </h3>
        <div id="custom-alert-message" class="text-gray-700 mb-6"></div>
        <button id="custom-alert-close" class="btn-primary">æˆ‘çŸ¥é“äº†</button>
      </div>
    </div>

    <script type="module">
      // Firebase SDKs
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        signInAnonymously,
        onAuthStateChanged,
        signOut,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        setLogLevel,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- å…¨å±€ç‹€æ…‹èˆ‡è®Šæ•¸ ---
      let hiraganaData = [];
      let geminiApiKey = localStorage.getItem("geminiApiKey") || "";
      let db, auth;
      let currentUser = null;
      let userProfile = null;
      let proficiencyChart = null;
      let currentMonth = new Date();
      let gameTimerInterval;
      let isAuthReady = false; // ç”¨ä¾†è¿½è¹¤ Firebase Auth æ˜¯å¦å·²æº–å‚™å°±ç·’
      let chatHistory = [];
      let isChatInitialized = false;
      let crosswordState = {
        cells: [],
        activeClue: null,
        direction: "H",
      };

      const localHiraganaData = [
        { hiragana: "ã‚", romaji: "a", word: "æœ (asa)" },
        { hiragana: "ã„", romaji: "i", word: "çŠ¬ (inu)" },
        { hiragana: "ã†", romaji: "u", word: "æµ· (umi)" },
        { hiragana: "ãˆ", romaji: "e", word: "é§… (eki)" },
        { hiragana: "ãŠ", romaji: "o", word: "ãŠé‡‘ (okane)" },
        { hiragana: "ã‹", romaji: "ka", word: "å‚˜ (kasa)" },
        { hiragana: "ã", romaji: "ki", word: "æœ¨ (ki)" },
        { hiragana: "ã", romaji: "ku", word: "é´ (kutsu)" },
        { hiragana: "ã‘", romaji: "ke", word: "ã‚±ãƒ¼ã‚­ (keeki)" },
        { hiragana: "ã“", romaji: "ko", word: "å­ä¾› (kodomo)" },
        { hiragana: "ã•", romaji: "sa", word: "é­š (sakana)" },
        { hiragana: "ã—", romaji: "shi", word: "å†™çœŸ (shashin)" },
        { hiragana: "ã™", romaji: "su", word: "å¯¿å¸ (sushi)" },
        { hiragana: "ã›", romaji: "se", word: "ä¸–ç•Œ (sekai)" },
        { hiragana: "ã", romaji: "so", word: "ç©º (sora)" },
        { hiragana: "ãŸ", romaji: "ta", word: "åµ (tamago)" },
        { hiragana: "ã¡", romaji: "chi", word: "åœ°ä¸‹é‰„ (chikatetsu)" },
        { hiragana: "ã¤", romaji: "tsu", word: "æœº (tsukue)" },
        { hiragana: "ã¦", romaji: "te", word: "æ‰‹ç´™ (tegami)" },
        { hiragana: "ã¨", romaji: "to", word: "æ™‚è¨ˆ (tokei)" },
        { hiragana: "ãª", romaji: "na", word: "åå‰ (namae)" },
        { hiragana: "ã«", romaji: "ni", word: "æ—¥æœ¬èª (nihongo)" },
        { hiragana: "ã¬", romaji: "nu", word: "å¸ƒ (nuno)" },
        { hiragana: "ã­", romaji: "ne", word: "çŒ« (neko)" },
        { hiragana: "ã®", romaji: "no", word: "å–‰ (nodo)" },
        { hiragana: "ã¯", romaji: "ha", word: "èŠ± (hana)" },
        { hiragana: "ã²", romaji: "hi", word: "é£›è¡Œæ©Ÿ (hikouki)" },
        { hiragana: "ãµ", romaji: "fu", word: "å¯Œå£«å±± (fujisan)" },
        { hiragana: "ã¸", romaji: "he", word: "éƒ¨å±‹ (heya)" },
        { hiragana: "ã»", romaji: "ho", word: "æœ¬ (hon)" },
        { hiragana: "ã¾", romaji: "ma", word: "æ¯æ—¥ (mainichi)" },
        { hiragana: "ã¿", romaji: "mi", word: "æ°´ (mizu)" },
        { hiragana: "ã‚€", romaji: "mu", word: "è™« (mushi)" },
        { hiragana: "ã‚", romaji: "me", word: "çœ¼é¡ (megane)" },
        { hiragana: "ã‚‚", romaji: "mo", word: "æ¡ƒ (momo)" },
        { hiragana: "ã‚„", romaji: "ya", word: "å±± (yama)" },
        { hiragana: "ã‚†", romaji: "yu", word: "é›ª (yuki)" },
        { hiragana: "ã‚ˆ", romaji: "yo", word: "å¤œ (yoru)" },
        { hiragana: "ã‚‰", romaji: "ra", word: "ãƒ©ãƒ¼ãƒ¡ãƒ³ (raamen)" },
        { hiragana: "ã‚Š", romaji: "ri", word: "ã‚Šã‚“ã” (ringo)" },
        { hiragana: "ã‚‹", romaji: "ru", word: "ç•™å®ˆ (rusu)" },
        { hiragana: "ã‚Œ", romaji: "re", word: "æ­´å² (rekishi)" },
        { hiragana: "ã‚", romaji: "ro", word: "ã‚ã†ãã (rousoku)" },
        { hiragana: "ã‚", romaji: "wa", word: "ç§ (watashi)" },
        { hiragana: "ã‚’", romaji: "wo", word: "ã€œã‚’ (åŠ©è©)" },
        { hiragana: "ã‚“", romaji: "n", word: "æ–°è (shinbun)" },
      ];

      // --- å‡½æ•¸å®šç¾© ---

      function showCustomAlert(title, message) {
        document.getElementById("custom-alert-title").textContent = title;
        const messageEl = document.getElementById("custom-alert-message");
        messageEl.innerHTML = ""; // Clear previous content

        const pre = document.createElement("pre");
        pre.textContent = message;
        messageEl.appendChild(pre);

        document.getElementById("custom-alert-modal").classList.add("active");
      }

      async function initializeFirebase() {
        try {
          // å„ªå…ˆä½¿ç”¨ Canvas ç’°å¢ƒæä¾›çš„è¨­å®š
          const firebaseConfig =
            typeof __firebase_config !== "undefined"
              ? JSON.parse(__firebase_config)
              : {
                  // é€™æ˜¯ä½ åŸæœ¬çš„è¨­å®šï¼Œä½œç‚ºå‚™ç”¨
                  apiKey: "AIzaSyAty2H0pPyis6b5Vrc69JSWGYFBuxU3MRg",
                  authDomain: "learn-b4116.firebaseapp.com",
                  projectId: "learn-b4116",
                  storageBucket: "learn-b4116.appspot.com",
                  messagingSenderId: "146098029176",
                  appId: "1:146098029176:web:2489c7a3975aba57a4e38d",
                };

          const app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getFirestore(app);
          setLogLevel("debug"); // é–‹ç™¼æ™‚å¯ä»¥è¨­ç‚º debug ä¾†çœ‹æ›´å¤šè³‡è¨Š
          return true;
        } catch (error) {
          console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
          showCustomAlert(
            "åˆå§‹åŒ–å¤±æ•—",
            `ç„¡æ³•é€£æ¥è‡³å¾Œç«¯æœå‹™ï¼Œéƒ¨åˆ†åŠŸèƒ½å°‡ç„¡æ³•ä½¿ç”¨ã€‚\néŒ¯èª¤è¨Šæ¯: ${error.message}`
          );
          return false;
        }
      }

      async function handleGoogleLogin() {
        if (!auth) {
          showCustomAlert("éŒ¯èª¤", "é©—è­‰æœå‹™å°šæœªåˆå§‹åŒ–ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
          return;
        }
        const provider = new GoogleAuthProvider();
        try {
          await signInWithPopup(auth, provider);
          document.getElementById("login-modal").classList.remove("active");
        } catch (error) {
          console.error("Google ç™»å…¥å¤±æ•—:", error);
          if (error.code === "auth/unauthorized-domain") {
            showCustomAlert(
              "ç™»å…¥å¤±æ•—",
              "é€™å€‹ç¶²ç«™çš„ç¶²åŸŸæœªè¢«æˆæ¬Šé€²è¡Œç™»å…¥ã€‚è«‹ç¢ºèªæ‚¨å·²åœ¨ Firebase æ§åˆ¶å°å°‡æ­¤ç¶²åŸŸåŠ å…¥æˆæ¬Šåˆ—è¡¨ã€‚"
            );
          } else {
            showCustomAlert("ç™»å…¥éŒ¯èª¤", `ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤: ${error.message}`);
          }
        }
      }

      async function loadUserProfile(uid) {
        // å¦‚æœæ˜¯åŒ¿åç”¨æˆ¶ï¼Œç›´æ¥ä½¿ç”¨æœ¬åœ°è³‡æ–™ï¼Œä¸è®€å– Firestore
        if (currentUser && currentUser.isAnonymous) {
          console.log("åŒ¿åç”¨æˆ¶ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™ã€‚");
          userProfile = {
            name: "è¨ªå®¢",
            isAnonymous: true,
            progress: {},
            studyRecords: [],
          };
          hiraganaData = localHiraganaData.map((item) => ({
            ...item,
            proficiency: 0,
          }));
          return; // ç›´æ¥è¿”å›ï¼Œä¸åŸ·è¡Œå¾ŒçºŒçš„ Firestore æ“ä½œ
        }

        const userProfileRef = doc(db, "users", uid);
        try {
          const userSnap = await getDoc(userProfileRef);
          if (userSnap.exists()) {
            userProfile = userSnap.data();
          } else {
            // å‰µå»ºæ–°çš„ä½¿ç”¨è€…è³‡æ–™
            userProfile = {
              name: currentUser.displayName || `ä½¿ç”¨è€…${uid.substring(0, 5)}`,
              email: currentUser.email || null,
              photoURL: currentUser.photoURL || null,
              isAnonymous: currentUser.isAnonymous,
              joinedDate: new Date().toISOString(),
              progress: {},
              studyRecords: [],
            };
            await setDoc(userProfileRef, userProfile);
          }
          // å°‡ Firestore çš„é€²åº¦åˆä½µåˆ°æœ¬åœ°è³‡æ–™
          hiraganaData = localHiraganaData.map((item) => ({
            ...item,
            proficiency: userProfile.progress?.[item.hiragana] || 0,
          }));
        } catch (error) {
          console.error("è®€å–ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:", error);
          if (
            error.code === "permission-denied" ||
            error.code === "missing-or-insufficient-permissions"
          ) {
            const ruleText = `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // å…è¨±å·²ç™»å…¥çš„ä½¿ç”¨è€…è®€å¯«è‡ªå·±çš„è³‡æ–™
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}`;
            showCustomAlert(
              "Firebase æ¬Šé™éŒ¯èª¤ (éå¸¸é‡è¦!)",
              "è®€å–ä½¿ç”¨è€…è³‡æ–™å¤±æ•—ã€‚é€™é€šå¸¸æ˜¯å› ç‚ºæ‚¨çš„ Firestore å®‰å…¨è¦å‰‡ä¸æ­£ç¢ºã€‚\n\n" +
                "è«‹ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿè§£æ±ºï¼š\n" +
                "1. å‰å¾€ Firebase æ§åˆ¶å° > Firestore Database > Rules åˆ†é ã€‚\n" +
                "2. åˆªé™¤æ‰€æœ‰ç¾æœ‰è¦å‰‡ã€‚\n" +
                "3. å°‡ä»¥ä¸‹è¦å‰‡å®Œæ•´è¤‡è£½ä¸¦è²¼ä¸Šï¼š\n\n" +
                ruleText +
                "\n\n" +
                "4. é»æ“Šã€Œç™¼å¸ƒ (Publish)ã€ã€‚\n" +
                "5. é‡æ–°æ•´ç†æ­¤é é¢ã€‚"
            );
          } else {
            showCustomAlert(
              "è³‡æ–™è®€å–éŒ¯èª¤",
              `ç„¡æ³•è®€å–æ‚¨çš„å€‹äººè³‡æ–™ï¼Œå°‡ä½¿ç”¨æœ¬æ©Ÿè³‡æ–™ã€‚\néŒ¯èª¤: ${error.message}`
            );
          }
          // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œé€€å›ä½¿ç”¨æœ¬åœ°è³‡æ–™
          userProfile = { name: "éŒ¯èª¤", progress: {}, studyRecords: [] };
          hiraganaData = localHiraganaData.map((item) => ({
            ...item,
            proficiency: 0,
          }));
        }
      }

      async function updateUserProgress(character, newProficiency) {
        if (!currentUser || currentUser.isAnonymous || !userProfile) return;

        const currentProficiency = userProfile.progress?.[character] || 0;
        if (newProficiency <= currentProficiency) return;

        // æ›´æ–°æœ¬åœ°ç‹€æ…‹
        userProfile.progress[character] = newProficiency;
        const today = new Date().toISOString().split("T")[0];
        if (!userProfile.studyRecords.includes(today)) {
          userProfile.studyRecords.push(today);
        }
        const item = hiraganaData.find((h) => h.hiragana === character);
        if (item) item.proficiency = newProficiency;

        // æ›´æ–° UI
        renderHiraganaCards();
        renderProficiencyChart();

        // æ›´æ–° Firestore
        const userProfileRef = doc(db, "users", currentUser.uid);
        try {
          await updateDoc(userProfileRef, {
            progress: userProfile.progress,
            studyRecords: userProfile.studyRecords,
          });
        } catch (error) {
          console.error("æ›´æ–°é€²åº¦å¤±æ•—:", error);
          if (
            error.code === "permission-denied" ||
            error.code === "missing-or-insufficient-permissions"
          ) {
            showCustomAlert(
              "æ¬Šé™éŒ¯èª¤",
              "æ›´æ–°å­¸ç¿’é€²åº¦å¤±æ•—ã€‚è«‹ç¢ºèªæ‚¨çš„ Firestore å®‰å…¨è¦å‰‡å·²è¨­å®šæ­£ç¢ºã€‚"
            );
          }
        }
      }

      function handleLogout() {
        signOut(auth).catch((error) => console.error("ç™»å‡ºå¤±æ•—:", error));
      }

      function updateUIForAuthState() {
        const loginButton = document.getElementById("login-button");
        const userMenu = document.getElementById("user-menu");
        const chatInput = document.getElementById("user-chat-input");
        const sendChatBtn = document.getElementById("send-chat-message");

        if (currentUser && !currentUser.isAnonymous && userProfile) {
          loginButton.classList.add("hidden");
          userMenu.classList.remove("hidden");
          userMenu.classList.add("flex");
          document.getElementById("user-name").textContent =
            userProfile.name?.split(" ")[0] || "ä½¿ç”¨è€…";
          document.getElementById("user-avatar").src =
            userProfile.photoURL ||
            `https://placehold.co/40x40/E2E8F0/4A5568?text=${
              userProfile.name?.[0] || "U"
            }`;
          document.getElementById("user-avatar").onerror = () => {
            document.getElementById("user-avatar").src =
              "https://placehold.co/40x40/E2E8F0/4A5568?text=ğŸ‘¤";
          };
        } else {
          loginButton.classList.remove("hidden");
          userMenu.classList.add("hidden");
          userMenu.classList.remove("flex");
        }

        if (geminiApiKey) {
          chatInput.disabled = false;
          sendChatBtn.disabled = false;
          document.getElementById("gemini-api-key").value = geminiApiKey;
          testApiKey(geminiApiKey, false); // åœ¨è¼‰å…¥æ™‚éœé»˜æ¸¬è©¦
        } else {
          chatInput.disabled = true;
          sendChatBtn.disabled = true;
        }
      }

      function showSection(sectionId) {
        document
          .querySelectorAll("#main-content > section")
          .forEach((section) => section.classList.add("hidden"));
        document.getElementById(sectionId).classList.remove("hidden");
        document.querySelectorAll(".nav-link").forEach((button) => {
          button.classList.toggle(
            "active",
            button.dataset.section === sectionId
          );
        });
        if (sectionId === "progress-calendar") renderProgressSection();
        if (sectionId === "phrase-practice")
          switchPracticeView("practice-menu");
        if (sectionId === "ai-conversation" && !isChatInitialized) {
          initializeChat();
        }
      }

      function renderHiraganaCards() {
        const container = document.getElementById("hiragana-cards-container");
        container.innerHTML = "";
        if (!hiraganaData || hiraganaData.length === 0) return;
        const proficiencyColors = [
          "bg-white/60",
          "bg-pink-100",
          "bg-pink-200",
          "bg-yellow-100",
          "bg-green-100",
          "bg-gradient-to-br from-green-200 to-blue-200",
        ];
        hiraganaData.forEach((item) => {
          const card = document.createElement("div");
          card.className = `sakura-card p-4 text-center flex flex-col items-center justify-between cursor-pointer ${
            proficiencyColors[item.proficiency || 0]
          }`;
          card.innerHTML = `
                    <div class="text-6xl font-bold text-gray-800 font-['Noto_Sans_JP']">${item.hiragana}</div>
                    <div class="text-xl text-gray-600">${item.romaji}</div>
                    <div class="text-xs text-gray-500 mt-2">ä¾‹: ${item.word}</div>
                `;
          card.addEventListener("click", () => {
            playSound(item.hiragana);
            updateUserProgress(
              item.hiragana,
              (item.proficiency || 0) + 1 > 5 ? 5 : (item.proficiency || 0) + 1
            );
          });
          container.appendChild(card);
        });
      }

      function playSound(text) {
        if ("speechSynthesis" in window) {
          window.speechSynthesis.cancel(); // é¿å…èªéŸ³é‡ç–Š
          const u = new SpeechSynthesisUtterance(text);
          u.lang = "ja-JP";
          u.rate = 0.9;
          window.speechSynthesis.speak(u);
        }
      }

      function switchPracticeView(viewId) {
        const practiceSection = document.getElementById("phrase-practice");
        practiceSection
          .querySelectorAll(":scope > div")
          .forEach((div) => div.classList.add("hidden"));
        document.getElementById(viewId).classList.remove("hidden");
      }

      function startDailyPractice() {
        switchPracticeView("daily-practice-interface");
        renderDailyCard();
      }
      function renderDailyCard() {
        if (hiraganaData.length === 0) return;
        const cardData =
          hiraganaData[Math.floor(Math.random() * hiraganaData.length)];
        const container = document.getElementById("daily-card-container");
        container.innerHTML = `
                <div class="text-8xl font-bold text-gray-800 font-['Noto_Sans_JP'] cursor-pointer">${cardData.hiragana}</div>
                <div class="mt-4 text-3xl text-gray-700">${cardData.romaji}</div>
                <p class="mt-2 text-xl text-gray-600">${cardData.word}</p>
                <button class="btn-primary mt-6" data-sound="${cardData.hiragana}">æ’­æ”¾ç™¼éŸ³</button>
            `;
        container
          .querySelector("button")
          .addEventListener("click", (e) => playSound(e.target.dataset.sound));
      }

      let currentCorrectAnswer = "",
        score = 0,
        timer = 30;
      function startWordMatchGame() {
        switchPracticeView("word-match-game-interface");
        document
          .getElementById("game-question-area")
          .classList.remove("hidden");
        document.getElementById("game-over-area").classList.add("hidden");
        score = 0;
        timer = 30;
        document.getElementById("game-score").textContent = score;
        document.getElementById("game-timer").textContent = timer;
        generateNewQuestion();
        if (gameTimerInterval) clearInterval(gameTimerInterval);
        gameTimerInterval = setInterval(() => {
          timer--;
          document.getElementById("game-timer").textContent = timer;
          if (timer <= 0) endWordMatchGame();
        }, 1000);
      }
      function generateNewQuestion() {
        if (hiraganaData.length < 4) return;
        document.getElementById("game-feedback").textContent = "";
        const shuffled = [...hiraganaData].sort(() => 0.5 - Math.random());
        const options = shuffled.slice(0, 4);
        const questionItem = options[Math.floor(Math.random() * 4)];
        currentCorrectAnswer = questionItem.romaji;
        document.getElementById("game-question-word").textContent =
          questionItem.hiragana;
        const optionsContainer = document.getElementById(
          "game-options-container"
        );
        optionsContainer.innerHTML = "";
        options
          .sort(() => 0.5 - Math.random())
          .forEach((opt) => {
            const button = document.createElement("button");
            button.className =
              "game-option-button p-4 rounded-lg text-xl font-bold";
            button.textContent = opt.romaji;
            button.dataset.answer = opt.romaji;
            button.addEventListener("click", checkAnswer);
            optionsContainer.appendChild(button);
          });
      }
      function checkAnswer(event) {
        const selectedAnswer = event.target.dataset.answer;
        document
          .querySelectorAll("#game-options-container button")
          .forEach((btn) => (btn.disabled = true));
        const feedbackEl = document.getElementById("game-feedback");
        if (selectedAnswer === currentCorrectAnswer) {
          score++;
          document.getElementById("game-score").textContent = score;
          event.target.classList.add("correct");
          feedbackEl.textContent = "æ­£ç¢ºï¼";
          feedbackEl.className = "mt-4 h-6 text-lg font-bold text-green-600";
        } else {
          event.target.classList.add("incorrect");
          feedbackEl.textContent = `éŒ¯èª¤ï¼ç­”æ¡ˆæ˜¯ ${currentCorrectAnswer}`;
          feedbackEl.className = "mt-4 h-6 text-lg font-bold text-red-600";
        }
        setTimeout(() => {
          if (timer > 0) generateNewQuestion();
        }, 1200);
      }
      function endWordMatchGame() {
        clearInterval(gameTimerInterval);
        document.getElementById("game-question-area").classList.add("hidden");
        const gameOverArea = document.getElementById("game-over-area");
        gameOverArea.classList.remove("hidden");
        document.getElementById("final-score").textContent = score;
      }

      function renderProgressSection() {
        renderCalendar();
        renderProficiencyChart();
      }
      function renderCalendar() {
        const grid = document.getElementById("calendar-grid");
        const monthYearEl = document.getElementById("calendar-month-year");
        grid.innerHTML = "";
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        monthYearEl.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++)
          grid.appendChild(document.createElement("div"));
        for (let day = 1; day <= daysInMonth; day++) {
          const dayEl = document.createElement("div");
          dayEl.className =
            "calendar-day flex items-center justify-center text-gray-700";
          dayEl.textContent = day;
          const dateStr = `${year}-${String(month + 1).padStart(
            2,
            "0"
          )}-${String(day).padStart(2, "0")}`;
          if (userProfile?.studyRecords?.includes(dateStr)) {
            dayEl.classList.add("studied", "text-white");
          }
          grid.appendChild(dayEl);
        }
      }
      function renderProficiencyChart() {
        const ctx = document
          .getElementById("proficiency-chart")
          .getContext("2d");
        if (proficiencyChart) proficiencyChart.destroy();
        if (!hiraganaData || hiraganaData.length === 0) return;
        const levels = [0, 0, 0, 0, 0, 0]; // 0 to 5
        hiraganaData.forEach((item) => {
          const p = item.proficiency || 0;
          levels[p]++;
        });
        proficiencyChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["æœªå­¸ç¿’", "åˆè­˜", "å…¥é–€", "ç†Ÿæ‚‰", "ç†Ÿç·´", "ç²¾é€š"],
            datasets: [
              {
                data: levels,
                backgroundColor: [
                  "#f3f4f6",
                  "#fce7f3",
                  "#fbcfe8",
                  "#f9a8d4",
                  "#93c5fd",
                  "#6ee7b7",
                ],
                borderColor: "rgba(255, 255, 255, 0.7)",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { position: "top" } },
          },
        });
      }

      // --- å’Œé¢¨å¡«å­—éŠæˆ²ç›¸é—œå‡½å¼ ---
      const sampleCrossword = {
        width: 5,
        height: 5,
        clues: [
          {
            id: 1,
            dir: "H",
            row: 0,
            col: 1,
            word: "ã­ã“",
            clue: "æœƒå–µå–µå«çš„å‹•ç‰©",
          },
          { id: 2, dir: "V", row: 0, col: 1, word: "ãªã¤", clue: "å¤å¤©" },
          {
            id: 3,
            dir: "H",
            row: 2,
            col: 0,
            word: "ã•ã‹ãª",
            clue: "åœ¨æ°´è£¡æ¸¸çš„",
          },
          {
            id: 4,
            dir: "V",
            row: 2,
            col: 4,
            word: "ãªã¾ãˆ",
            clue: "ä½ çš„...ï¼Ÿ (Your Name)",
          },
          {
            id: 5,
            dir: "H",
            row: 4,
            col: 1,
            word: "ã„ã¬",
            clue: "äººé¡æœ€å¥½çš„æœ‹å‹",
          },
        ],
      };

      function startCrosswordGame() {
        switchPracticeView("crossword-game-interface");
        renderCrossword(sampleCrossword);
      }

      function renderCrossword(puzzle) {
        const grid = document.getElementById("crossword-grid");
        const cluesContainer = document.getElementById("crossword-clues");
        grid.innerHTML = "";
        cluesContainer.innerHTML = "";

        grid.style.gridTemplateColumns = `repeat(${puzzle.width}, 40px)`;

        // åˆå§‹åŒ–äºŒç¶­é™£åˆ—ä¾†å­˜æ”¾å„²å­˜æ ¼å…ƒç´ å’Œè³‡è¨Š
        crosswordState.cells = Array(puzzle.height)
          .fill(null)
          .map(() => Array(puzzle.width).fill(null));

        // å»ºç«‹æ‰€æœ‰å„²å­˜æ ¼çš„å®¹å™¨
        for (let r = 0; r < puzzle.height; r++) {
          for (let c = 0; c < puzzle.width; c++) {
            const cellContainer = document.createElement("div");
            cellContainer.className = "crossword-cell-container";
            grid.appendChild(cellContainer);
            crosswordState.cells[r][c] = {
              container: cellContainer,
              input: null,
              clues: {},
            };
          }
        }

        // å¡«å…¥è¬é¡Œçš„å„²å­˜æ ¼
        puzzle.clues.forEach((clue) => {
          for (let i = 0; i < clue.word.length; i++) {
            let r = clue.row,
              c = clue.col;
            if (clue.dir === "H") c += i;
            else r += i;

            let cellInfo = crosswordState.cells[r][c];
            if (!cellInfo.input) {
              // å¦‚æœé‚„æ²’æœ‰è¼¸å…¥æ¡†ï¼Œå°±å»ºç«‹ä¸€å€‹
              const input = document.createElement("input");
              input.type = "text";
              input.maxLength = 1;
              input.className = "crossword-cell";
              input.dataset.row = r;
              input.dataset.col = c;
              input.autocomplete = "off";

              cellInfo.container.appendChild(input);
              cellInfo.input = input;
              cellInfo.answer = "";
            }

            cellInfo.clues[clue.dir] = clue.id;
            if (i === 0) {
              const numberSpan = document.createElement("span");
              numberSpan.className = "crossword-number";
              numberSpan.textContent = clue.id;
              cellInfo.container.appendChild(numberSpan);
            }

            if (clue.dir === "H") cellInfo.answerH = clue.word[i];
            if (clue.dir === "V") cellInfo.answerV = clue.word[i];
          }
        });

        // æ¸²æŸ“æç¤ºåˆ—è¡¨ä¸¦åŠ å…¥äº‹ä»¶
        const sortedClues = [...puzzle.clues].sort((a, b) => a.id - b.id);
        sortedClues.forEach((clue) => {
          const clueEl = document.createElement("div");
          clueEl.className =
            "crossword-clue p-2 rounded-md cursor-pointer transition";
          clueEl.textContent = `${clue.id}. ${clue.clue} (${
            clue.dir === "H" ? "æ©«" : "ç›´"
          })`;
          clueEl.dataset.clueId = clue.id;
          clueEl.dataset.dir = clue.dir;
          clueEl.addEventListener("click", () => {
            setActiveClue(clue.id, clue.dir);
            const startCell = crosswordState.cells[clue.row][clue.col];
            if (startCell && startCell.input) startCell.input.focus();
          });
          cluesContainer.appendChild(clueEl);
        });

        // ç‚ºæ‰€æœ‰è¼¸å…¥æ¡†åŠ å…¥äº‹ä»¶ç›£è½
        grid.querySelectorAll(".crossword-cell").forEach((input) => {
          input.addEventListener("input", handleCrosswordInput);
          input.addEventListener("keydown", handleCrosswordKeyDown);
          input.addEventListener("focus", handleCrosswordFocus);
        });
      }

      function setActiveClue(clueId, direction) {
        crosswordState.activeClue = clueId;
        crosswordState.direction = direction;

        // æ›´æ–°æç¤ºåˆ—è¡¨çš„ highlight
        document.querySelectorAll(".crossword-clue").forEach((c) => {
          c.classList.toggle(
            "active",
            c.dataset.clueId == clueId && c.dataset.dir == direction
          );
        });

        // æ›´æ–°æ ¼å­çš„ highlight
        document.querySelectorAll(".crossword-cell").forEach((input) => {
          const r = parseInt(input.dataset.row);
          const c = parseInt(input.dataset.col);
          const cellInfo = crosswordState.cells[r][c];
          input.classList.toggle(
            "highlight",
            cellInfo && cellInfo.clues[direction] == clueId
          );
        });
      }

      function handleCrosswordFocus(e) {
        const r = parseInt(e.target.dataset.row);
        const c = parseInt(e.target.dataset.col);
        const cellInfo = crosswordState.cells[r][c];

        if (cellInfo.clues[crosswordState.direction]) {
          setActiveClue(
            cellInfo.clues[crosswordState.direction],
            crosswordState.direction
          );
        } else if (cellInfo.clues["H"]) {
          setActiveClue(cellInfo.clues["H"], "H");
        } else if (cellInfo.clues["V"]) {
          setActiveClue(cellInfo.clues["V"], "V");
        }
      }

      function handleCrosswordInput(e) {
        const r = parseInt(e.target.dataset.row);
        const c = parseInt(e.target.dataset.col);

        if (e.target.value) {
          let nextR = r,
            nextC = c;
          if (crosswordState.direction === "H") nextC++;
          else nextR++;

          if (
            nextR < crosswordState.cells.length &&
            nextC < crosswordState.cells[0].length
          ) {
            const nextCell = crosswordState.cells[nextR][nextC];
            if (nextCell && nextCell.input) {
              nextCell.input.focus();
            }
          }
        }
      }

      function handleCrosswordKeyDown(e) {
        const r = parseInt(e.target.dataset.row);
        const c = parseInt(e.target.dataset.col);
        let nextR = r,
          nextC = c;

        switch (e.key) {
          case "ArrowUp":
            e.preventDefault();
            nextR--;
            break;
          case "ArrowDown":
            e.preventDefault();
            nextR++;
            break;
          case "ArrowLeft":
            e.preventDefault();
            nextC--;
            break;
          case "ArrowRight":
            e.preventDefault();
            nextC++;
            break;
          case "Backspace":
            if (!e.target.value) {
              e.preventDefault();
              if (crosswordState.direction === "H") nextC--;
              else nextR--;
            }
            break;
        }

        if (
          nextR >= 0 &&
          nextR < crosswordState.cells.length &&
          nextC >= 0 &&
          nextC < crosswordState.cells[0].length
        ) {
          const nextCell = crosswordState.cells[nextR][nextC];
          if (nextCell && nextCell.input) {
            nextCell.input.focus();
          }
        }
      }

      function checkCrossword() {
        let allCorrect = true;
        let filledCount = 0;
        document.querySelectorAll(".crossword-cell").forEach((input) => {
          const r = parseInt(input.dataset.row);
          const c = parseInt(input.dataset.col);
          const cellInfo = crosswordState.cells[r][c];
          const answer =
            (crosswordState.direction === "H"
              ? cellInfo.answerH
              : cellInfo.answerV) ||
            cellInfo.answerH ||
            cellInfo.answerV;

          input.classList.remove("correct", "incorrect");
          if (input.value) {
            filledCount++;
            if (input.value === answer) {
              input.classList.add("correct");
            } else {
              input.classList.add("incorrect");
              allCorrect = false;
            }
          } else {
            allCorrect = false; // æœ‰ç©ºæ ¼å°±ä¸ç®—å…¨éƒ¨æ­£ç¢º
          }
        });

        if (allCorrect && filledCount > 0) {
          showCustomAlert("æ­å–œï¼", "ğŸ‰ ä½ å®Œæˆäº†æ‰€æœ‰çš„è¬é¡Œï¼å¤ªæ£’äº†ï¼");
        } else if (filledCount > 0) {
          showCustomAlert(
            "å†åŠ æŠŠå‹ï¼",
            "æœ‰äº›ç­”æ¡ˆä¸å°å–”ï¼Œçœ‹çœ‹é‚£äº›ç´…è‰²çš„æ ¼å­å§ï¼"
          );
        } else {
          showCustomAlert("æç¤º", "è«‹å…ˆè©¦è‘—å¡«å¯«ç­”æ¡ˆå–”ï¼");
        }
      }

      async function testApiKey(key, showAlert = true) {
        const statusEl = document.getElementById("api-status");
        if (!key) {
          if (showAlert) {
            statusEl.textContent = "ç‹€æ…‹: è«‹è¼¸å…¥ API Key";
            statusEl.className =
              "text-center text-sm font-semibold text-red-500 h-5";
          }
          return false;
        }
        statusEl.textContent = "ç‹€æ…‹: æ¸¬è©¦ä¸­...";
        statusEl.className =
          "text-center text-sm font-semibold text-orange-500 h-5";
        try {
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`;
          const response = await fetch(apiUrl, {
            method: "POST",
            body: JSON.stringify({
              contents: [{ parts: [{ text: "Hello" }] }],
            }),
          });
          if (response.ok) {
            statusEl.textContent = "ç‹€æ…‹: é€£æ¥æˆåŠŸï¼";
            statusEl.className =
              "text-center text-sm font-semibold text-green-600 h-5";
            if (showAlert)
              showCustomAlert("æˆåŠŸ", "API Key æ¸¬è©¦æˆåŠŸï¼ŒAI å°è©±åŠŸèƒ½å·²å•Ÿç”¨ï¼");
            return true;
          } else {
            const error = await response.json();
            statusEl.textContent = `ç‹€æ…‹: é€£æ¥å¤±æ•—`;
            statusEl.className =
              "text-center text-sm font-semibold text-red-500 h-5";
            if (showAlert)
              showCustomAlert(
                "é€£æ¥å¤±æ•—",
                `API Key ç„¡æ³•ä½¿ç”¨ã€‚\néŒ¯èª¤: ${error.error.message}`
              );
            return false;
          }
        } catch (error) {
          statusEl.textContent = "ç‹€æ…‹: ç¶²è·¯éŒ¯èª¤";
          statusEl.className =
            "text-center text-sm font-semibold text-red-500 h-5";
          if (showAlert)
            showCustomAlert(
              "ç¶²è·¯éŒ¯èª¤",
              `ç„¡æ³•é€£æ¥è‡³ Google API æœå‹™ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šã€‚`
            );
          return false;
        }
      }

      // --- AI å°è©±ç›¸é—œå‡½å¼ ---
      function initializeChat() {
        chatHistory = [
          {
            role: "user",
            parts: [
              {
                text: "ä½ ç¾åœ¨æ˜¯ä¸€ä½è¦ªåˆ‡ã€å‹å–„çš„æ—¥èªå­¸ç¿’å¤¥ä¼´ï¼Œåå«ã€Œæ«»ã€ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å’Œç°¡å–®çš„æ—¥èªèˆ‡æˆ‘å°è©±ï¼Œé¼“å‹µæˆ‘ç·´ç¿’ã€‚æˆ‘å€‘çš„å°è©±å¾ç¾åœ¨é–‹å§‹ã€‚",
              },
            ],
          },
          {
            role: "model",
            parts: [
              {
                text: "ã“ã‚“ã«ã¡ã¯ï¼æˆ‘æ˜¯æ«» (Sakura)ï¼Œä½ çš„å°ˆå±¬æ—¥èªå­¸ç¿’å¤¥ä¼´ï¼å¾ˆé«˜èˆˆèªè­˜ä½ ï½ æº–å‚™å¥½ä¸€èµ·ç·´ç¿’æ—¥æ–‡äº†å—ï¼Ÿã©ã‚“ãªã“ã¨ã§ã‚‚èã„ã¦ãã ã•ã„ã­ï¼(ä»€éº¼äº‹éƒ½å¯ä»¥å•æˆ‘å–”ï¼)",
              },
            ],
          },
        ];

        const chatDisplay = document.getElementById("chat-display");
        chatDisplay.innerHTML = ""; // æ¸…ç©ºé è¨­è¨Šæ¯
        appendChatMessage("model", chatHistory[1].parts[0].text);
        isChatInitialized = true;
      }

      function appendChatMessage(role, text) {
        const chatDisplay = document.getElementById("chat-display");
        const messageWrapper = document.createElement("div");
        const messageBubble = document.createElement("div");

        messageBubble.textContent = text;
        messageBubble.className =
          "p-3 rounded-lg max-w-xs lg:max-w-md break-words shadow";

        if (role === "user") {
          messageWrapper.className = "flex justify-end mb-4";
          messageBubble.classList.add("bg-pink-200", "text-gray-800");
        } else if (role === "model") {
          messageWrapper.className = "flex justify-start mb-4";
          messageBubble.classList.add("bg-white", "text-gray-800");
        } else {
          // error
          messageWrapper.className = "flex justify-center mb-4";
          messageBubble.classList.add(
            "bg-red-100",
            "text-red-700",
            "border",
            "border-red-300",
            "w-full"
          );
        }

        messageWrapper.appendChild(messageBubble);
        chatDisplay.appendChild(messageWrapper);
        chatDisplay.scrollTop = chatDisplay.scrollHeight; // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
      }

      async function sendChatMessage() {
        const inputEl = document.getElementById("user-chat-input");
        const statusEl = document.getElementById("chat-status");
        const sendBtn = document.getElementById("send-chat-message");

        const userMessage = inputEl.value.trim();
        if (!userMessage) return;

        if (!geminiApiKey) {
          showCustomAlert("éŒ¯èª¤", "è«‹å…ˆåœ¨è¨­å®šä¸­è¼¸å…¥æœ‰æ•ˆçš„ Gemini API Keyã€‚");
          return;
        }

        // ç¦ç”¨è¼¸å…¥ä¸¦é¡¯ç¤ºè®€å–ç‹€æ…‹
        inputEl.value = "";
        inputEl.disabled = true;
        sendBtn.disabled = true;
        statusEl.textContent = "æ«» AI æ€è€ƒä¸­...";

        // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
        appendChatMessage("user", userMessage);

        // åŠ å…¥æ­·å²ç´€éŒ„
        chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

        try {
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
          const payload = {
            contents: chatHistory,
          };

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error.message || `HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`
            );
          }

          const result = await response.json();
          const aiResponse = result.candidates[0].content.parts[0].text;

          // é¡¯ç¤º AI è¨Šæ¯
          appendChatMessage("model", aiResponse);

          // å°‡ AI å›è¦†åŠ å…¥æ­·å²ç´€éŒ„
          chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
        } catch (error) {
          console.error("AI å°è©±éŒ¯èª¤:", error);
          appendChatMessage("error", `ç³Ÿç³•ï¼Œå°è©±å‡ºéŒ¯äº†ï¼š\n${error.message}`);
          // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œå¾æ­·å²ç´€éŒ„ä¸­ç§»é™¤æœ€å¾Œä¸€ç­†ä½¿ç”¨è€…è¨Šæ¯ï¼Œä»¥ä¾¿é‡è©¦
          chatHistory.pop();
        } finally {
          // é‡æ–°å•Ÿç”¨è¼¸å…¥
          inputEl.disabled = false;
          sendBtn.disabled = false;
          statusEl.textContent = "";
          inputEl.focus();
        }
      }

      function setupEventListeners() {
        document
          .querySelectorAll(".nav-link")
          .forEach((button) =>
            button.addEventListener("click", () =>
              showSection(button.dataset.section)
            )
          );
        document
          .getElementById("login-button")
          .addEventListener("click", () =>
            document.getElementById("login-modal").classList.add("active")
          );
        document
          .getElementById("google-login-button")
          .addEventListener("click", handleGoogleLogin);
        document
          .getElementById("logout-button")
          .addEventListener("click", handleLogout);
        document
          .getElementById("settings-button")
          .addEventListener("click", () =>
            document.getElementById("settings-modal").classList.add("active")
          );
        document
          .getElementById("settings-modal")
          .addEventListener("click", (e) => {
            if (e.target === e.currentTarget)
              e.currentTarget.classList.remove("active");
          });
        document
          .getElementById("login-modal")
          .addEventListener("click", (e) => {
            if (e.target === e.currentTarget)
              e.currentTarget.classList.remove("active");
          });
        document
          .getElementById("custom-alert-close")
          .addEventListener("click", () =>
            document
              .getElementById("custom-alert-modal")
              .classList.remove("active")
          );

        document
          .getElementById("test-api-connection")
          .addEventListener("click", async () => {
            const key = document.getElementById("gemini-api-key").value.trim();
            const success = await testApiKey(key);
            if (success) {
              geminiApiKey = key;
              localStorage.setItem("geminiApiKey", key);
              document.getElementById("user-chat-input").disabled = false;
              document.getElementById("send-chat-message").disabled = false;
            }
          });

        document
          .getElementById("clear-api-key")
          .addEventListener("click", () => {
            document.getElementById("gemini-api-key").value = "";
            geminiApiKey = "";
            localStorage.removeItem("geminiApiKey");
            document.getElementById("api-status").textContent = "ç‹€æ…‹: å·²æ¸…ç©º";
            document.getElementById("user-chat-input").disabled = true;
            document.getElementById("send-chat-message").disabled = true;
          });

        // AI Chat Listeners
        document
          .getElementById("send-chat-message")
          .addEventListener("click", sendChatMessage);
        document
          .getElementById("user-chat-input")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.target.disabled) {
              sendChatMessage();
            }
          });

        // Game Listeners
        document.querySelectorAll("[data-practice]").forEach((button) => {
          button.addEventListener("click", (e) => {
            const practiceType = e.currentTarget.dataset.practice;
            if (practiceType === "daily-practice") startDailyPractice();
            else if (practiceType === "word-match-game") startWordMatchGame();
            else if (practiceType === "crossword-game") startCrosswordGame();
          });
        });
        document.querySelectorAll(".back-to-menu").forEach((button) =>
          button.addEventListener("click", () => {
            clearInterval(gameTimerInterval);
            switchPracticeView("practice-menu");
          })
        );
        document
          .getElementById("next-daily-card")
          .addEventListener("click", renderDailyCard);
        document
          .getElementById("restart-word-match-game")
          .addEventListener("click", startWordMatchGame);
        document
          .getElementById("check-crossword-btn")
          .addEventListener("click", checkCrossword);
        document.getElementById("prev-month").addEventListener("click", () => {
          currentMonth.setMonth(currentMonth.getMonth() - 1);
          renderCalendar();
        });
        document.getElementById("next-month").addEventListener("click", () => {
          currentMonth.setMonth(currentMonth.getMonth() + 1);
          renderCalendar();
        });
      }

      function showContent() {
        document.getElementById("loading-state").classList.add("hidden");
        showSection("pronunciation-teaching");
      }

      // --- ä¸»åŸ·è¡Œæµç¨‹ ---
      async function main() {
        setupEventListeners();

        // è§£æ±ºè¡Œå‹•è£ç½®èªéŸ³å•é¡Œï¼šåœ¨é¦–æ¬¡ä½¿ç”¨è€…äº’å‹•æ™‚ã€Œé ç†±ã€èªéŸ³å¼•æ“
        const warmUpSpeech = () => {
          if ("speechSynthesis" in window) {
            // æ’­æ”¾ä¸€å€‹ç„¡è²çš„å…§å®¹ä¾†åˆå§‹åŒ–/å–šé†’èªéŸ³å¼•æ“
            window.speechSynthesis.speak(new SpeechSynthesisUtterance(""));
          }
        };
        // ä½¿ç”¨ { once: true } ä¾†ç¢ºä¿é€™å€‹äº‹ä»¶åªæœƒè¢«è§¸ç™¼ä¸€æ¬¡
        document.body.addEventListener("click", warmUpSpeech, { once: true });
        document.body.addEventListener("touchend", warmUpSpeech, {
          once: true,
        });

        const firebaseReady = await initializeFirebase();

        if (!firebaseReady) {
          // Firebase åˆå§‹åŒ–å¾¹åº•å¤±æ•—ï¼Œåªèƒ½ç”¨æœ¬åœ°æ¨¡å¼
          userProfile = { name: "è¨ªå®¢ (é›¢ç·š)", progress: {}, studyRecords: [] };
          hiraganaData = localHiraganaData.map((h) => ({
            ...h,
            proficiency: 0,
          }));
          updateUIForAuthState();
          renderHiraganaCards();
          renderProgressSection();
          showContent();
          return;
        }

        onAuthStateChanged(auth, async (user) => {
          currentUser = user;
          if (user) {
            await loadUserProfile(user.uid);
          } else {
            // å¦‚æœä½¿ç”¨è€…ç™»å‡ºï¼Œæˆ–åˆå§‹ç‹€æ…‹ç‚ºç©ºï¼Œè‡ªå‹•è½‰ç‚ºåŒ¿åç™»å…¥
            try {
              await signInAnonymously(auth);
              // åŒ¿åç™»å…¥å¾Œ onAuthStateChanged æœƒå†æ¬¡è§¸ç™¼ï¼Œ
              // å±†æ™‚ user ç‰©ä»¶å°±æœƒå­˜åœ¨ï¼Œä¸¦é€²å…¥ä¸Šé¢çš„ if å€å¡Š
              return; // é¿å…åŸ·è¡Œå¾ŒçºŒçš„ UI æ›´æ–°
            } catch (error) {
              console.error("åŒ¿åç™»å…¥å¤±æ•—:", error);
              // åŒ¿åç™»å…¥ä¹Ÿå¤±æ•—ï¼Œåªèƒ½ç”¨æœ¬åœ°æ¨¡å¼
              userProfile = {
                name: "è¨ªå®¢ (é›¢ç·š)",
                progress: {},
                studyRecords: [],
              };
              hiraganaData = localHiraganaData.map((h) => ({
                ...h,
                proficiency: 0,
              }));
            }
          }

          updateUIForAuthState();
          renderHiraganaCards();
          renderProgressSection();
          if (!isAuthReady) {
            showContent();
            isAuthReady = true;
          }
        });

        // è™•ç† Canvas ç’°å¢ƒçš„è‡ªå‹•ç™»å…¥
        try {
          if (
            typeof __initial_auth_token !== "undefined" &&
            __initial_auth_token
          ) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else if (!auth.currentUser) {
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error("åˆå§‹ç™»å…¥å¤±æ•—:", error);
          if (!auth.currentUser) {
            await signInAnonymously(auth);
          }
        }
      }

      // --- å•Ÿå‹•æ‡‰ç”¨ ---
      main();
    </script>
  </body>
</html>
